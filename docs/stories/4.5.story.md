# Story 4.5: Testing Infrastructure

## Status: Draft

## Story

**As a** Developer,  
**I want** comprehensive testing infrastructure,  
**so that** I can catch regressions and ensure quality with confidence.

## Acceptance Criteria

1. End-to-end tests cover critical user flows (order creation, status updates, menu management)
2. Visual regression testing prevents unintended UI changes
3. Load testing validates WebSocket connection stability under stress
4. API contract tests ensure frontend/backend compatibility
5. Test coverage reports generated and tracked
6. CI pipeline runs all test types on PR
7. Test documentation explains testing strategy and how to run tests

## Tasks / Subtasks

- [ ] **Task 1: E2E testing with Playwright** (AC: 1, 6)
  - [ ] 1.1 Install and configure Playwright
  - [ ] 1.2 Create test fixtures for database seeding
  - [ ] 1.3 Write E2E test: Admin creates menu item
  - [ ] 1.4 Write E2E test: Staff creates order with items
  - [ ] 1.5 Write E2E test: Kitchen updates order status (drag-and-drop)
  - [ ] 1.6 Write E2E test: Real-time update received across tabs
  - [ ] 1.7 Configure E2E tests in CI pipeline
  - [ ] 1.8 Add Playwright test reports

- [ ] **Task 2: Visual regression testing** (AC: 2)
  - [ ] 2.1 Choose tool (Playwright visual comparisons or Percy/Chromatic)
  - [ ] 2.2 Capture baseline screenshots for key pages
  - [ ] 2.3 Configure visual diff threshold
  - [ ] 2.4 Add visual tests for: Menu list, Order entry, Kitchen board
  - [ ] 2.5 Add visual tests for: Loading states, Error states, Empty states
  - [ ] 2.6 Configure visual tests in CI

- [ ] **Task 3: Load testing for WebSockets** (AC: 3)
  - [ ] 3.1 Choose load testing tool (k6 or Artillery)
  - [ ] 3.2 Create load test script for WebSocket connections
  - [ ] 3.3 Test 100 concurrent connections
  - [ ] 3.4 Test rapid message throughput (100 msg/sec)
  - [ ] 3.5 Document performance baselines
  - [ ] 3.6 Add load test to CI (optional, can be manual)

- [ ] **Task 4: API contract testing** (AC: 4)
  - [ ] 4.1 Generate OpenAPI spec from existing routes
  - [ ] 4.2 Create contract tests that validate responses match spec
  - [ ] 4.3 Add contract tests to CI
  - [ ] 4.4 Set up frontend API client type generation from spec

- [ ] **Task 5: Test coverage reporting** (AC: 5)
  - [ ] 5.1 Configure Vitest coverage reporter
  - [ ] 5.2 Set minimum coverage thresholds (70% lines, 60% branches)
  - [ ] 5.3 Add coverage report to CI output
  - [ ] 5.4 Create coverage badge for README

- [ ] **Task 6: Test documentation** (AC: 7)
  - [ ] 6.1 Create `docs/testing.md` with testing strategy
  - [ ] 6.2 Document how to run each test type
  - [ ] 6.3 Document test file naming conventions
  - [ ] 6.4 Document mock/fixture patterns
  - [ ] 6.5 Add troubleshooting section for common issues

## Dev Notes

### Architecture References

**Current Testing Setup:**
- Vitest 1.0+ for unit/integration tests
- React Testing Library for component tests
- Test files in `packages/*/tests/`

[Source: docs/architecture.md#Tech Stack]

**Project Structure:**
```
packages/
├── api/tests/          # Backend tests
├── web/tests/          # Frontend tests
└── shared/tests/       # Shared utility tests (to be created)
```

[Source: docs/architecture.md#Project Structure]

**Recommended E2E Setup:**
```typescript
// playwright.config.ts
export default defineConfig({
  testDir: './e2e',
  webServer: {
    command: 'pnpm dev',
    port: 5173,
  },
});
```

**Coverage Configuration:**
```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      thresholds: {
        lines: 70,
        branches: 60,
      },
    },
  },
});
```

### Testing Requirements

**E2E Test Location:**
- Create `e2e/` directory in project root
- Use `*.spec.ts` naming for Playwright tests

**Visual Test Storage:**
- Screenshots stored in `e2e/__screenshots__/`
- Add to .gitignore (or track baseline only)

[Source: docs/architecture.md#Project Structure]

## Out of Scope

- Performance benchmarking dashboard
- Mutation testing
- Security scanning (separate story)

## Estimated Effort

**Story Points:** 8

## Dependencies

- All core features complete (Epics 1-3)
- CI/CD pipeline exists

## Definition of Done

- [ ] All 7 acceptance criteria verified
- [ ] E2E tests pass in CI
- [ ] Coverage thresholds met
- [ ] Documentation complete

---

## Change Log

| Date       | Version | Description         | Author            |
|------------|---------|---------------------|-------------------|
| 2026-01-15 | 0.1     | Initial story draft | Bob (Scrum Master)|
