# Story 1.3: Menu Item CRUD API Endpoints

## Status: Ready for Review

## Story

**As an** Admin user,  
**I want** API endpoints to manage menu items,  
**so that** I can create, view, update, and delete items programmatically.

## Acceptance Criteria

1. `POST /api/menu-items` creates a new menu item with validation (name required, price > 0)
2. `GET /api/menu-items` returns all menu items (with optional query filters: category, foodType, available)
3. `GET /api/menu-items/:id` returns a single menu item by ID (404 if not found)
4. `PUT /api/menu-items/:id` updates an existing menu item (404 if not found, validation applied)
5. `DELETE /api/menu-items/:id` soft-deletes or removes a menu item (404 if not found)
6. All endpoints return consistent JSON response format with appropriate HTTP status codes
7. Validation errors return 400 with descriptive error messages
8. API responses include the full menu item object on create/update

## Tasks / Subtasks

- [x] **Task 1: Install Zod for Validation** (AC: 1, 7)
  - [x] Add `zod` dependency to api package
  - [x] Create validation schemas in `packages/api/src/schemas/menu-item.schema.ts`
  - [x] Define `createMenuItemSchema` with name (required), price (> 0), category (enum), etc.
  - [x] Define `updateMenuItemSchema` as partial version of create schema

- [x] **Task 2: Create Menu Service** (AC: 1, 2, 3, 4, 5)
  - [x] Create `packages/api/src/services/menu.service.ts`
  - [x] Implement `getAllMenuItems(filters)` with optional category, foodType, available filtering
  - [x] Implement `getMenuItemById(id)` returning item or null
  - [x] Implement `createMenuItem(data)` with validated input
  - [x] Implement `updateMenuItem(id, data)` with partial update support
  - [x] Implement `deleteMenuItem(id)` - use hard delete for simplicity (soft-delete optional)

- [x] **Task 3: Create Error Utilities** (AC: 6, 7)
  - [x] Create `packages/api/src/utils/errors.ts` with `AppError` class
  - [x] Define error codes: `NOT_FOUND`, `VALIDATION_ERROR`, `INTERNAL_ERROR`
  - [x] Create `packages/api/src/middleware/error-handler.ts`
  - [x] Handle `AppError`, `ZodError`, and generic errors with appropriate status codes

- [x] **Task 4: Create Menu Item Routes** (AC: 1, 2, 3, 4, 5, 6, 8)
  - [x] Create `packages/api/src/routes/menu-items.ts`
  - [x] Implement `GET /api/menu-items` with query param parsing for filters
  - [x] Implement `POST /api/menu-items` with Zod validation
  - [x] Implement `GET /api/menu-items/:id` with 404 handling
  - [x] Implement `PUT /api/menu-items/:id` with Zod validation
  - [x] Implement `DELETE /api/menu-items/:id` with 404 handling

- [x] **Task 5: Create Route Aggregator** (AC: 6)
  - [x] Create/update `packages/api/src/routes/index.ts`
  - [x] Mount menu-items routes at `/menu-items`
  - [x] Mount health routes at `/health` (already exists)
  - [x] Export route factory function

- [x] **Task 6: Update Express App** (AC: 6)
  - [x] Update `packages/api/src/app.ts` to use route aggregator
  - [x] Register error handler middleware (after routes)
  - [x] Ensure JSON body parser is configured

- [x] **Task 7: Create API Response Helpers** (AC: 6, 8)
  - [x] Create `packages/api/src/utils/response.ts`
  - [x] Implement `sendSuccess(res, data, status)` helper
  - [x] Implement `sendError(res, code, message, status)` helper
  - [x] Ensure consistent response format: `{ data: ... }` or `{ error: { code, message } }`

- [x] **Task 8: Write Unit Tests for Menu Service** (AC: 1, 2, 3, 4, 5)
  - [x] Create `packages/api/tests/menu.service.test.ts`
  - [x] Test `getAllMenuItems` with and without filters
  - [x] Test `getMenuItemById` found and not found cases
  - [x] Test `createMenuItem` with valid data
  - [x] Test `updateMenuItem` with partial data
  - [x] Test `deleteMenuItem` success and not found cases

- [x] **Task 9: Write Integration Tests for Menu Endpoints** (AC: 1-8)
  - [x] Create `packages/api/tests/menu-items.test.ts`
  - [x] Test `POST /api/menu-items` with valid and invalid data
  - [x] Test `GET /api/menu-items` with and without filters
  - [x] Test `GET /api/menu-items/:id` found and 404
  - [x] Test `PUT /api/menu-items/:id` with valid and invalid data
  - [x] Test `DELETE /api/menu-items/:id` success and 404
  - [x] Verify response format consistency across all endpoints

## Dev Notes

### Previous Story Insights
[Source: Story 1.2 Dev Agent Record]

- Prisma 7.x requires `@prisma/adapter-pg` with pg Pool for direct PostgreSQL connections
- Prisma client singleton pattern implemented in `packages/api/src/lib/prisma.ts`
- Use `prisma` import from `../lib/prisma.js` with `.js` extension for ESM compatibility
- Database tests already validate CRUD operations work at Prisma level
- Total test suite at 10/10 passing - maintain this quality level

### API Response Format
[Source: architecture.md#REST API Specification]

**Success Response:**
```json
{
  "data": { /* MenuItem object or array */ },
  "total": 10  // Optional, for list endpoints
}
```

**Error Response:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid request data",
    "details": [...]  // Optional, for validation errors
  }
}
```

### Menu Item Endpoints Specification
[Source: architecture.md#Menu Item Endpoints]

| Method | Endpoint | Description | Success Status |
|--------|----------|-------------|----------------|
| GET | `/api/menu-items` | List all (with filters) | 200 |
| POST | `/api/menu-items` | Create menu item | 201 |
| GET | `/api/menu-items/:id` | Get by ID | 200 |
| PUT | `/api/menu-items/:id` | Update item | 200 |
| DELETE | `/api/menu-items/:id` | Delete item | 204 or 200 |

**Query Parameters for GET /api/menu-items:**
| Parameter | Type | Description |
|-----------|------|-------------|
| category | string | Filter by Category enum |
| foodType | string | Filter by FoodType enum |
| available | boolean | Filter by availability |

### Validation Schema
[Source: architecture.md#Data Models, shared types]

```typescript
// packages/api/src/schemas/menu-item.schema.ts
import { z } from 'zod';
import { Category, FoodType } from '@prisma/client';

export const createMenuItemSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  price: z.number().positive('Price must be greater than 0'),
  ingredients: z.array(z.string()).default([]),
  imageUrl: z.string().url().optional().nullable(),
  category: z.nativeEnum(Category),
  foodType: z.nativeEnum(FoodType).default(FoodType.OTHER),
  available: z.boolean().default(true),
});

export const updateMenuItemSchema = createMenuItemSchema.partial();
```

### Error Handling Pattern
[Source: architecture.md#Error Handling Middleware]

```typescript
// packages/api/src/utils/errors.ts
export class AppError extends Error {
  constructor(
    public code: string,
    message: string,
    public statusCode: number = 400
  ) {
    super(message);
    this.name = 'AppError';
  }
}

// Common error factory functions
export const notFound = (resource: string) => 
  new AppError('NOT_FOUND', `${resource} not found`, 404);
```

### Project Structure - New Files
[Source: architecture.md#Project Structure]

| File | Purpose |
|------|---------|
| `packages/api/src/routes/menu-items.ts` | Menu item endpoint handlers |
| `packages/api/src/routes/index.ts` | Route aggregator |
| `packages/api/src/services/menu.service.ts` | Menu business logic |
| `packages/api/src/schemas/menu-item.schema.ts` | Zod validation schemas |
| `packages/api/src/utils/errors.ts` | Custom error classes |
| `packages/api/src/utils/response.ts` | Response helper functions |
| `packages/api/src/middleware/error-handler.ts` | Global error handler |
| `packages/api/tests/menu.service.test.ts` | Service unit tests |
| `packages/api/tests/menu-items.test.ts` | Endpoint integration tests |

### Tech Stack Versions
[Source: architecture.md#Tech Stack]

| Technology | Version | Purpose |
|------------|---------|---------|
| Zod | 3.22+ | Schema validation |
| Express | 4.18+ | HTTP routing |
| Prisma | 7.x | Database access |
| Vitest | 1.0+ | Testing |

## Testing

### Testing Standards
[Source: architecture.md#Testing Strategy]

- **Framework:** Vitest 1.0+
- **Test Location:** `packages/api/tests/`
- **Pattern:** Integration tests for endpoints using supertest
- **Mocking:** Use `vi.fn()` and `vi.mock()` for unit tests
- **Coverage:** All CRUD operations, validation errors, 404 cases

### Test Pattern for API Endpoints

```typescript
// packages/api/tests/menu-items.test.ts
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import request from 'supertest';
import { createApp } from '../src/app';

describe('Menu Items API', () => {
  let app: Express;
  
  beforeAll(async () => {
    app = createApp();
  });

  describe('POST /api/menu-items', () => {
    it('should create menu item with valid data', async () => {
      const res = await request(app)
        .post('/api/menu-items')
        .send({
          name: 'Test Pizza',
          price: 15.99,
          ingredients: ['cheese', 'tomato'],
          category: 'MAIN',
        });
      
      expect(res.status).toBe(201);
      expect(res.body.data).toHaveProperty('id');
      expect(res.body.data.name).toBe('Test Pizza');
    });

    it('should return 400 for invalid data', async () => {
      const res = await request(app)
        .post('/api/menu-items')
        .send({ name: '', price: -5 });
      
      expect(res.status).toBe(400);
      expect(res.body.error.code).toBe('VALIDATION_ERROR');
    });
  });
});
```

---

## Dev Agent Record

**Agent Model Used:** Claude Sonnet 4.5

**Debug Log References:**
- TypeScript compilation error with ZodError - Fixed by using `error.issues` instead of `error.errors` (correct ZodError property)
- TypeScript compilation error with params access - Fixed by using `req.params['id']!` with non-null assertion instead of `req.params.id`
- Health endpoint returning 404 - Fixed by changing route definition from `router.get('/health')` to `router.get('/')` since route is mounted at `/health`
- App dependency injection - Updated `createApp()` to accept `prisma` parameter for database access in routes

**Completion Notes:**
- All 9 tasks completed with full implementation
- Zod validation library installed and configured for request validation
- Service layer pattern implemented with MenuService class containing all CRUD operations
- Comprehensive error handling with custom AppError class and global error middleware
- 5 REST endpoints implemented: GET (list with filters), POST (create), GET by ID, PUT (update), DELETE
- Route aggregator pattern implemented to organize API routes
- Response helper utilities created for consistent API responses
- 10 unit tests written for MenuService with mocked Prisma client
- 15 integration tests written for API endpoints using supertest
- All 35 tests passing (10 service unit + 15 API integration + 6 DB + 4 health)
- TypeScript compilation passing with strict mode
- Linting passing (only console warnings remain)

**File List:**
- Created `packages/api/src/schemas/menu-item.schema.ts` - Zod validation schemas (createMenuItemSchema, updateMenuItemSchema)
- Created `packages/api/src/services/menu.service.ts` - MenuService class with CRUD operations and filtering logic
- Created `packages/api/src/utils/errors.ts` - AppError class with factory functions (notFound, validationError, internalError)
- Created `packages/api/src/middleware/error-handler.ts` - Global error handling middleware for Express
- Created `packages/api/src/utils/response.ts` - Response helper functions (sendSuccess, sendError)
- Created `packages/api/src/routes/menu-items.ts` - Menu item CRUD endpoints (5 routes)
- Created `packages/api/src/routes/index.ts` - Route aggregator mounting all API routes
- Created `packages/api/tests/menu.service.test.ts` - Unit tests for MenuService (10 tests)
- Created `packages/api/tests/menu-items.test.ts` - Integration tests for API endpoints (15 tests)
- Modified `packages/api/src/app.ts` - Updated to accept prisma parameter and use route aggregator
- Modified `packages/api/src/index.ts` - Updated to pass prisma instance to createApp
- Modified `packages/api/src/routes/health.ts` - Fixed route definition from `/health` to `/` for proper mounting
- Modified `packages/api/tests/health.test.ts` - Updated to pass prisma to createApp function

**Change Log:**
- Added zod, supertest, @types/supertest dependencies to api package
- Implemented service layer pattern with MenuService for business logic separation
- Implemented comprehensive error handling with custom error classes and middleware
- Implemented route aggregator pattern for scalable route organization
- Created response helper utilities for consistent API responses
- Fixed health endpoint routing to avoid double path segments
- Added comprehensive test coverage with unit and integration tests

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 0.1 | Initial story draft | Bob (SM) |
