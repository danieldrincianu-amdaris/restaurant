# Story 4.1: Performance Optimizations

## Status: Draft

## Story

**As a** Restaurant Staff or Kitchen user,  
**I want** the application to remain fast and responsive even with many active orders,  
**so that** I can efficiently manage high-volume service periods without UI lag.

## Acceptance Criteria

1. List components (OrderCard, KitchenOrderCard, MenuItemCard) use React.memo to prevent unnecessary re-renders
2. CSS containment applied to animated components for improved animation performance
3. Menu items API response cached client-side with 5-minute TTL
4. Order list renders smoothly with 100+ active orders
5. WebSocket message batching implemented for high-volume updates (>10 messages/second)
6. Performance metrics logged in development mode for monitoring
7. No visual regressions from optimizations

## Tasks / Subtasks

- [ ] **Task 1: React.memo optimization for list components** (AC: 1, 4, 7)
  - [ ] 1.1 Add React.memo to OrderCard with custom comparison function
  - [ ] 1.2 Add React.memo to KitchenOrderCard with custom comparison function
  - [ ] 1.3 Add React.memo to MenuItemCard with custom comparison function
  - [ ] 1.4 Verify no visual regressions with existing tests
  - [ ] 1.5 Add performance test comparing render counts before/after

- [ ] **Task 2: CSS containment for animations** (AC: 2, 4, 7)
  - [ ] 2.1 Add `contain: layout style paint` to OrderCard
  - [ ] 2.2 Add `contain: layout style paint` to KitchenOrderCard
  - [ ] 2.3 Test animation performance with 50+ cards
  - [ ] 2.4 Verify animations still work correctly

- [ ] **Task 3: Client-side caching for menu items** (AC: 3)
  - [ ] 3.1 Create `useMenuItemsCache` hook with localStorage + TTL
  - [ ] 3.2 Implement cache invalidation on menu item CRUD operations
  - [ ] 3.3 Add cache-first fetch strategy with background refresh
  - [ ] 3.4 Write tests for cache hit/miss/expiry scenarios

- [ ] **Task 4: WebSocket message batching** (AC: 5)
  - [ ] 4.1 Create `useBatchedUpdates` hook that collects messages within 100ms window
  - [ ] 4.2 Apply batched state updates to reduce render cycles
  - [ ] 4.3 Test with rapid order status changes
  - [ ] 4.4 Ensure no message loss during batching

- [ ] **Task 5: Performance monitoring utilities** (AC: 6)
  - [ ] 5.1 Create `useRenderCount` development hook
  - [ ] 5.2 Add console logging for render counts in dev mode only
  - [ ] 5.3 Create simple performance report component (dev-only)

## Dev Notes

### Architecture References

**Component Locations:**
- `packages/web/src/components/staff/OrderCard.tsx`
- `packages/web/src/components/kitchen/KitchenOrderCard.tsx`
- `packages/web/src/components/menu/MenuItemCard.tsx`
- `packages/web/src/styles/index.css`

[Source: docs/architecture.md#Project Structure]

**Tech Stack:**
- React 18.2+ (supports automatic batching)
- Vitest for testing
- Zustand for state (already optimized for selective re-renders)

[Source: docs/architecture.md#Tech Stack]

**Previous Story Insights (3.10):**
- QA review identified React.memo as future optimization
- CSS containment recommended for animation performance at scale
- Current animations work well up to ~50 orders

[Source: docs/stories/3.10.story.md#QA Results]

### Testing Requirements

**Test File Locations:**
- `packages/web/tests/components/staff/OrderCard.test.tsx`
- `packages/web/tests/components/kitchen/KitchenOrderCard.test.tsx`
- `packages/web/tests/hooks/` for new hooks

**Testing Frameworks:**
- Vitest + React Testing Library
- Use `vi.fn()` for tracking render counts

[Source: docs/architecture.md#Tech Stack]

## Out of Scope

- Backend API caching (Redis) - future story
- Service Worker caching - future story
- Virtual scrolling for very large lists (1000+)

## Estimated Effort

**Story Points:** 5

## Definition of Done

- [ ] All 7 acceptance criteria verified
- [ ] Performance tests demonstrate improvement
- [ ] No visual regressions in existing tests
- [ ] Code reviewed and follows patterns

---

## Change Log

| Date       | Version | Description         | Author            |
|------------|---------|---------------------|-------------------|
| 2026-01-15 | 0.1     | Initial story draft | Bob (Scrum Master)|
