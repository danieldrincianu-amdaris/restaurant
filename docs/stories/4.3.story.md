# Story 4.3: Tech Debt Reduction

## Status: Draft

## Story

**As a** Developer,  
**I want** to reduce accumulated technical debt,  
**so that** the codebase remains maintainable and tests are reliable.

## Acceptance Criteria

1. All React act() warnings in test suite suppressed or fixed properly
2. Duplicate validation logic consolidated into shared utilities
3. Error handling follows consistent pattern across all API routes
4. TypeScript strict mode enabled and all errors resolved
5. Unused dependencies removed from all packages
6. Console warnings/errors in test output reduced to zero (non-test-failure warnings)
7. ESLint rules consistent across all packages

## Tasks / Subtasks

- [ ] **Task 1: Fix React act() warnings in tests** (AC: 1, 6)
  - [ ] 1.1 Audit all test files for act() warnings
  - [ ] 1.2 Wrap async state updates in proper act() blocks
  - [ ] 1.3 Add waitFor() where needed for async operations
  - [ ] 1.4 Create test utility for common async patterns
  - [ ] 1.5 Verify all tests pass without warnings

- [ ] **Task 2: Consolidate validation logic** (AC: 2)
  - [ ] 2.1 Audit validation code in API routes and services
  - [ ] 2.2 Extract common validators to `packages/shared/src/utils/validation.ts`
  - [ ] 2.3 Create Zod schemas for common patterns (table number, price, etc.)
  - [ ] 2.4 Update API routes to use shared validators
  - [ ] 2.5 Update frontend forms to use shared validators
  - [ ] 2.6 Write tests for shared validators

- [ ] **Task 3: Standardize error handling** (AC: 3)
  - [ ] 3.1 Create `AppError` class with standard structure
  - [ ] 3.2 Define error codes enum (VALIDATION_ERROR, NOT_FOUND, etc.)
  - [ ] 3.3 Update error-handler middleware to use standard format
  - [ ] 3.4 Update all routes to throw consistent errors
  - [ ] 3.5 Update frontend to parse standardized errors
  - [ ] 3.6 Write tests for error handling

- [ ] **Task 4: Enable TypeScript strict mode** (AC: 4)
  - [ ] 4.1 Enable strict mode in tsconfig.base.json
  - [ ] 4.2 Fix strict null check errors in packages/api
  - [ ] 4.3 Fix strict null check errors in packages/web
  - [ ] 4.4 Fix strict null check errors in packages/shared
  - [ ] 4.5 Add explicit return types where required
  - [ ] 4.6 Verify all packages compile without errors

- [ ] **Task 5: Dependency cleanup** (AC: 5)
  - [ ] 5.1 Run `pnpm why` to identify unused dependencies
  - [ ] 5.2 Remove unused dependencies from each package
  - [ ] 5.3 Update outdated dependencies (minor versions)
  - [ ] 5.4 Verify all functionality still works after cleanup

- [ ] **Task 6: ESLint consistency** (AC: 7)
  - [ ] 6.1 Create shared ESLint config in root
  - [ ] 6.2 Extend shared config in each package
  - [ ] 6.3 Fix all ESLint errors/warnings
  - [ ] 6.4 Add pre-commit hook for linting (optional)

## Dev Notes

### Architecture References

**Shared Package:**
- `packages/shared/src/utils/validation.ts` - validation utilities
- `packages/shared/src/types/` - shared type definitions

[Source: docs/architecture.md#Project Structure]

**Error Handling Pattern:**
```typescript
// Recommended pattern from architecture
import { AppError, ErrorCode } from '@restaurant/shared';

throw new AppError(ErrorCode.NOT_FOUND, 'Menu item not found');
```

[Source: docs/architecture.md#Middleware]

**TypeScript Configuration:**
- Base config: `tsconfig.base.json`
- Per-package configs extend base

[Source: docs/architecture.md#Project Structure]

**Validation Library:**
- Zod 3.22+ for schema validation

[Source: docs/architecture.md#Tech Stack]

### Testing Requirements

**Test Coverage:**
- All shared validators need unit tests
- Error handling tested via integration tests
- TypeScript compilation is implicit test

**Test Location:**
- `packages/shared/tests/` for shared utilities
- Existing test files for integration

[Source: docs/architecture.md#Tech Stack]

## Out of Scope

- Major version dependency upgrades
- Migrating away from current tech stack
- Adding new development tools

## Estimated Effort

**Story Points:** 5

## Definition of Done

- [ ] All 7 acceptance criteria verified
- [ ] Zero test warnings in CI output
- [ ] TypeScript strict mode enabled
- [ ] All existing tests pass
- [ ] No new ESLint errors

---

## Change Log

| Date       | Version | Description         | Author            |
|------------|---------|---------------------|-------------------|
| 2026-01-15 | 0.1     | Initial story draft | Bob (Scrum Master)|
