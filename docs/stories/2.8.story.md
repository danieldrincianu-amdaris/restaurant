# Story 2.8: Staff Active Orders List

## Status: Draft

## Story

**As a** Restaurant Staff user,  
**I want** to view my active orders and their status,  
**so that** I can track order progress and make edits.

## Acceptance Criteria

1. Active orders page at `/staff/orders` displays all non-completed/canceled orders
2. Each order card shows: order ID, table #, server name, status, item count, time since creation
3. Status displayed with color-coded badge (Pending=blue, In Progress=yellow, etc.)
4. Tap/click order opens order detail view
5. "Edit" button on orders in PENDING status opens order editor
6. Filter tabs or dropdown: All, My Orders (by server name), By Status
7. Orders sorted by creation time (newest first) or by status
8. Auto-refresh or manual refresh button to update order list

## Tasks / Subtasks

- [ ] **Task 1: Create useOrders Hook for Fetching Orders** (AC: 1, 8)
  - [ ] Create `packages/web/src/hooks/useOrders.ts`
  - [ ] Implement `fetchOrders()` that calls `GET /api/orders`
  - [ ] Add optional filters: status, tableNumber
  - [ ] Handle loading state (`isLoading`)
  - [ ] Handle error state with error message
  - [ ] Add `refresh()` function for manual refresh
  - [ ] Filter out COMPLETED and CANCELED orders by default (or via parameter)

- [ ] **Task 2: Create OrderCard Component** (AC: 2, 3)
  - [ ] Create `packages/web/src/components/staff/OrderCard.tsx`
  - [ ] Display: order ID (short format), table number, server name
  - [ ] Display: status badge with color coding (PENDING=blue, IN_PROGRESS=yellow, HALTED=red, COMPLETED=green)
  - [ ] Display: item count from order.items.length
  - [ ] Display: time since creation (e.g., "3 min ago", "1 hr ago")
  - [ ] Implement `formatTimeElapsed()` utility function
  - [ ] Style as card with consistent layout per wireframe

- [ ] **Task 3: Create OrderStatusBadge Component** (AC: 3)
  - [ ] Create `packages/web/src/components/ui/OrderStatusBadge.tsx`
  - [ ] Accept `status: OrderStatus` prop
  - [ ] Color mapping: PENDING=blue-500, IN_PROGRESS=yellow-500, HALTED=red-500, COMPLETED=green-500, CANCELED=gray-500
  - [ ] Display status text in human-readable format
  - [ ] Consistent pill/badge styling

- [ ] **Task 4: Implement OrdersPage with Order List** (AC: 1, 2, 4, 7)
  - [ ] Replace stub content in `packages/web/src/pages/staff/OrdersPage.tsx`
  - [ ] Integrate useOrders hook to fetch active orders
  - [ ] Display orders in responsive grid layout (2 columns on tablet, 1 on mobile)
  - [ ] Sort orders by createdAt descending (newest first)
  - [ ] Loading state: show skeleton or spinner
  - [ ] Empty state: "No active orders" with link to create new order
  - [ ] Error state: show error message with retry button

- [ ] **Task 5: Add Filter Controls** (AC: 6)
  - [ ] Add filter tabs: "All Orders", "My Orders"
  - [ ] "My Orders" filters by server name (needs mechanism to identify current server)
  - [ ] Add status dropdown filter: All, Pending, In Progress, Halted
  - [ ] Store filter state in component state
  - [ ] Apply filters client-side or via API query params

- [ ] **Task 6: Add Manual Refresh Button** (AC: 8)
  - [ ] Add refresh button (ğŸ”„ icon) in header
  - [ ] Call `refresh()` from useOrders hook on click
  - [ ] Show loading indicator during refresh
  - [ ] Disable button during refresh to prevent double-clicks

- [ ] **Task 7: Implement Order Card Actions** (AC: 4, 5)
  - [ ] Make entire OrderCard clickable to open detail view
  - [ ] Navigate to `/staff/orders/:id/edit` when tapped (for now - detail view in future)
  - [ ] Show "Edit" button only for PENDING orders
  - [ ] Edit button navigates to `/staff/orders/:id/edit`
  - [ ] Non-editable orders (IN_PROGRESS, HALTED) show "View" action instead

- [ ] **Task 8: Write useOrders Hook Tests** (AC: 1, 8)
  - [ ] Create `packages/web/tests/hooks/useOrders.test.ts`
  - [ ] Test successful orders fetch returns order list
  - [ ] Test loading state is true during fetch
  - [ ] Test error state populated on API failure
  - [ ] Test refresh function re-fetches orders
  - [ ] Test filters are applied correctly

- [ ] **Task 9: Write OrderCard Component Tests** (AC: 2, 3)
  - [ ] Create `packages/web/tests/components/OrderCard.test.tsx`
  - [ ] Test renders order ID, table number, server name
  - [ ] Test renders correct status badge with color
  - [ ] Test renders item count
  - [ ] Test renders time elapsed
  - [ ] Test Edit button shown only for PENDING orders
  - [ ] Test click navigates to edit page

- [ ] **Task 10: Write OrdersPage Integration Tests** (AC: 1, 4, 5, 6, 7)
  - [ ] Create `packages/web/tests/pages/OrdersPage.test.tsx`
  - [ ] Test page displays list of orders
  - [ ] Test orders are sorted by creation time
  - [ ] Test filter tabs filter orders correctly
  - [ ] Test clicking order navigates to edit
  - [ ] Test empty state when no orders
  - [ ] Test loading state during fetch
  - [ ] Test refresh button triggers re-fetch

## Dev Notes

### Previous Story Context (Story 2.7)

Story 2.7 created the order submission flow and a stub OrdersPage:

**Key Files from Story 2.7:**
- `packages/web/src/pages/staff/OrdersPage.tsx` - Stub page with "Coming Soon" message â†’ REPLACE with full implementation
- `packages/web/src/hooks/useCreateOrder.ts` - Pattern to follow for useOrders hook
- `packages/web/src/router/index.tsx` - Route already exists: `/staff/orders`

**Completion Notes from Story 2.7:**
- Success flow redirects to `/staff/orders` after order submission
- OrdersPage already registered in router and exported from pages/staff/index.ts

### API Specifications

[Source: docs/architecture.md#Order Endpoints]

**GET /api/orders - List Orders:**
```
Query Parameters:
- status: string (optional) - Filter by order status
- tableNumber: number (optional) - Filter by table number

Response: 200 OK
{
  "data": [
    {
      "id": "clq0987654321",
      "tableNumber": 5,
      "serverName": "John",
      "status": "PENDING",
      "createdAt": "2026-01-13T12:30:00Z",
      "updatedAt": "2026-01-13T12:30:00Z",
      "items": [
        {
          "id": "clq1111111111",
          "menuItemId": "clq1234567890",
          "quantity": 2,
          "specialInstructions": "No olives",
          "menuItem": { /* MenuItem object */ }
        }
      ]
    }
  ],
  "total": 1
}
```

### Data Models

[Source: docs/architecture.md#Shared TypeScript Interfaces]

```typescript
// packages/shared/src/types/order.ts
export enum OrderStatus {
  PENDING = 'PENDING',
  IN_PROGRESS = 'IN_PROGRESS',
  COMPLETED = 'COMPLETED',
  HALTED = 'HALTED',
  CANCELED = 'CANCELED',
}

export interface Order {
  id: string;
  tableNumber: number;
  serverName: string;
  status: OrderStatus;
  createdAt: string;
  updatedAt: string;
  items: OrderItem[];
}
```

### UI/UX Specifications

[Source: docs/front-end-spec.md#Screen 4: Staff â€” Active Orders List]

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Active Orders                                  [+ New Order]   â”‚
â”‚                                                                 â”‚
â”‚  [All Orders] [My Orders] [By Status â–¼]           ğŸ”„ Refresh   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Order #127      ğŸ”µ     â”‚  â”‚ Order #126      ğŸŸ¡     â”‚         â”‚
â”‚  â”‚ Table 5    â±ï¸ 3 min   â”‚  â”‚ Table 12   â±ï¸ 8 min   â”‚         â”‚
â”‚  â”‚ Server: John           â”‚  â”‚ Server: Maria          â”‚         â”‚
â”‚  â”‚ 4 items                â”‚  â”‚ 2 items                â”‚         â”‚
â”‚  â”‚ [View] [Edit]          â”‚  â”‚ [View]                 â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Status Color Mapping:**
- ğŸ”µ PENDING: `bg-blue-100 text-blue-800`
- ğŸŸ¡ IN_PROGRESS: `bg-yellow-100 text-yellow-800`
- ğŸŸ¢ COMPLETED: `bg-green-100 text-green-800`
- ğŸ”´ HALTED: `bg-red-100 text-red-800`
- âš« CANCELED: `bg-gray-100 text-gray-800`

**Interaction Notes:**
[Source: docs/front-end-spec.md#Screen 4]
- Cards update in real-time as status changes (WebSocket - future Epic 3)
- Tapping card opens Order Detail modal/view
- "My Orders" filters by current server name
- New orders animate in from top
- Edit button only on PENDING orders

### File Locations

**New Files to Create:**
- `packages/web/src/hooks/useOrders.ts` - Order fetching hook
- `packages/web/src/components/staff/OrderCard.tsx` - Order card component
- `packages/web/src/components/ui/OrderStatusBadge.tsx` - Status badge component
- `packages/web/tests/hooks/useOrders.test.ts` - Hook tests
- `packages/web/tests/components/OrderCard.test.tsx` - Component tests
- `packages/web/tests/pages/OrdersPage.test.tsx` - Page tests

**Files to Modify:**
- `packages/web/src/pages/staff/OrdersPage.tsx` - Replace stub with full implementation

### Utility Functions

**Time Elapsed Formatting:**
```typescript
// Helper to format time since creation
function formatTimeElapsed(createdAt: string): string {
  const now = new Date();
  const created = new Date(createdAt);
  const diffMs = now.getTime() - created.getTime();
  const diffMin = Math.floor(diffMs / 60000);
  
  if (diffMin < 1) return 'Just now';
  if (diffMin < 60) return `${diffMin} min`;
  const diffHrs = Math.floor(diffMin / 60);
  if (diffHrs < 24) return `${diffHrs} hr`;
  return `${Math.floor(diffHrs / 24)} days`;
}
```

### Component Structure

**OrdersPage Component:**
```typescript
function OrdersPage(): JSX.Element {
  const { orders, isLoading, error, refresh } = useOrders();
  const [filter, setFilter] = useState<'all' | 'my'>('all');
  const [statusFilter, setStatusFilter] = useState<OrderStatus | null>(null);
  
  // Filter active orders (exclude COMPLETED and CANCELED)
  const activeOrders = orders.filter(o => 
    o.status !== 'COMPLETED' && o.status !== 'CANCELED'
  );
  
  // Apply additional filters
  const filteredOrders = activeOrders.filter(o => {
    if (filter === 'my') return o.serverName === currentServer;
    if (statusFilter) return o.status === statusFilter;
    return true;
  });
  
  // Sort by createdAt descending
  const sortedOrders = [...filteredOrders].sort(
    (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
  );
}
```

**OrderCard Props:**
```typescript
interface OrderCardProps {
  order: Order;
  onEdit?: (orderId: string) => void;
  onView?: (orderId: string) => void;
}
```

### Existing Patterns to Follow

**Hook Pattern (from useCreateOrder):**
```typescript
export function useOrders() {
  const [orders, setOrders] = useState<Order[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchOrders = async (filters?: { status?: OrderStatus }) => {
    setIsLoading(true);
    setError(null);
    try {
      const response = await api.get<{ data: Order[] }>('/orders', filters);
      setOrders(response.data);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to fetch orders');
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchOrders();
  }, []);

  return { orders, isLoading, error, refresh: fetchOrders };
}
```

### Server Name Identification

For "My Orders" filter, the current server name needs to be identified. Options:
1. Store server name in localStorage when creating order
2. Add a simple server name input/selector in header
3. For MVP: use a simple prompt or localStorage value

**Recommended approach for MVP:** Store last used server name in localStorage on order creation, use for filtering.

## Testing

### Testing Standards

[Source: docs/architecture.md#Testing Strategy]

**Frontend Component Tests:**
- Framework: Vitest + React Testing Library
- Location: `packages/web/tests/`
- Pattern: `{component-name}.test.tsx`
- Use `userEvent.setup()` for user interactions (required to prevent hangs)
- Mock API calls using `vi.mock()`
- Mock `useNavigate` from react-router-dom for navigation tests

**Hook Tests:**
- Location: `packages/web/tests/hooks/`
- Pattern: `{hook-name}.test.ts`
- Use `renderHook` from `@testing-library/react`
- Mock fetch/api calls

### Key Test Scenarios

1. **Order List Display:**
   - Orders fetched on page load
   - Loading state shown during fetch
   - Orders rendered in grid layout
   - Empty state when no orders

2. **Order Card:**
   - All fields displayed correctly
   - Status badge has correct color
   - Time elapsed formatted correctly
   - Edit button conditional on PENDING status

3. **Filter Functionality:**
   - All Orders shows all active orders
   - My Orders filters by server name
   - Status dropdown filters correctly
   - Filters combinable

4. **Refresh:**
   - Refresh button triggers API call
   - Loading indicator during refresh
   - Orders updated after refresh

5. **Navigation:**
   - Click order navigates to edit page
   - Edit button navigates to edit page
   - New Order button navigates to new order page

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 0.1 | Initial story draft | Bob (SM) |
