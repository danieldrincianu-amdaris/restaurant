# Story 2.7: Staff Order Submission

## Status: Draft

## Story

**As a** Restaurant Staff user,  
**I want** to submit completed orders to the kitchen,  
**so that** food preparation can begin.

## Acceptance Criteria

1. "Submit Order" button visible when order has table #, server name, and at least one item
2. Button disabled with visual indicator if requirements not met
3. Submit creates order via API and redirects to active orders list
4. Success toast notification: "Order #X submitted to kitchen"
5. Error displays message without losing order data
6. Clear order button resets order builder (with confirmation if items exist)
7. Submitted order status is PENDING

## Tasks / Subtasks

- [ ] **Task 1: Create Order Submission Hook** (AC: 3, 4, 5, 7)
  - [ ] Create `packages/web/src/hooks/useCreateOrder.ts`
  - [ ] Implement `createOrder` function that calls `POST /api/orders`
  - [ ] Handle loading state (`isSubmitting`)
  - [ ] Handle error state with error message
  - [ ] Return created order data on success
  - [ ] Format OrderContext items to API CreateOrderInput format

- [ ] **Task 2: Add Submit Order Button to OrderBuilder** (AC: 1, 2)
  - [ ] Add "Submit Order" button at bottom of OrderBuilder component
  - [ ] Implement validation logic: require tableNumber, serverName, at least 1 item
  - [ ] Disable button when validation fails with visual indicator (opacity, cursor)
  - [ ] Show tooltip or hint text explaining why button is disabled
  - [ ] Style button with primary action colors (blue-600 bg, white text)
  - [ ] Touch-friendly: minimum 44x44px height

- [ ] **Task 3: Implement Submit Order Flow** (AC: 3, 4, 5, 7)
  - [ ] Wire Submit button to useCreateOrder hook
  - [ ] On click: show loading state on button ("Submitting...")
  - [ ] On success: show success toast "Order #X submitted to kitchen"
  - [ ] On success: clear order context via `clearOrder()`
  - [ ] On success: redirect to `/staff/orders` using `useNavigate`
  - [ ] On error: show error toast with API error message
  - [ ] On error: preserve order data (no clear, no redirect)

- [ ] **Task 4: Add Clear Order Button** (AC: 6)
  - [ ] Add "Clear" button next to Submit button
  - [ ] Style as secondary/ghost button (gray text, no fill)
  - [ ] If order has items: show ConfirmDialog before clearing
  - [ ] Confirmation message: "Clear this order? All items will be removed."
  - [ ] On confirm: call `clearOrder()` from OrderContext
  - [ ] If order is empty: clear without confirmation

- [ ] **Task 5: Create Active Orders List Page Stub** (AC: 3)
  - [ ] Create `packages/web/src/pages/staff/OrdersPage.tsx` (placeholder)
  - [ ] Add route `/staff/orders` to router
  - [ ] Display simple "Active Orders" header and "Coming soon" message
  - [ ] Include "New Order" button linking to `/staff/orders/new`

- [ ] **Task 6: Write useCreateOrder Hook Tests** (AC: 3, 4, 5, 7)
  - [ ] Create `packages/web/tests/hooks/useCreateOrder.test.ts`
  - [ ] Test successful order creation returns order data
  - [ ] Test loading state is true during submission
  - [ ] Test error state populated on API failure
  - [ ] Test proper API payload format

- [ ] **Task 7: Write OrderBuilder Submit Integration Tests** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Update `packages/web/tests/components/OrderBuilder.test.tsx`
  - [ ] Test Submit button disabled when no items
  - [ ] Test Submit button disabled when no table number
  - [ ] Test Submit button disabled when no server name
  - [ ] Test Submit button enabled when all requirements met
  - [ ] Test Clear button shows confirmation when items exist
  - [ ] Test Clear button clears without confirmation when empty

- [ ] **Task 8: Write NewOrderPage Submission Integration Tests** (AC: 3, 4, 5)
  - [ ] Update `packages/web/tests/pages/NewOrderPage.test.tsx`
  - [ ] Test successful submission flow (mock API, verify toast, verify redirect)
  - [ ] Test error handling (mock API failure, verify error toast, data preserved)

## Dev Notes

### Previous Story Context (Story 2.6)

Story 2.6 completed the OrderBuilder component with:
- OrderItemRow with quantity controls (+/-)
- SpecialInstructionsModal for per-item instructions
- ConfirmDialog component for confirmations
- All wired to OrderContext

**Key Files from Story 2.6:**
- `packages/web/src/components/staff/OrderBuilder.tsx` - MODIFY to add Submit/Clear buttons
- `packages/web/src/components/staff/OrderItemRow.tsx` - No changes needed
- `packages/web/src/components/staff/SpecialInstructionsModal.tsx` - No changes needed
- `packages/web/src/components/ui/ConfirmDialog.tsx` - REUSE for Clear confirmation
- `packages/web/src/contexts/OrderContext.tsx` - Use existing clearOrder()

### API Specifications

[Source: docs/architecture.md#Order Endpoints]

**POST /api/orders - Create Order:**
```json
// Request Body
{
  "tableNumber": 5,
  "serverName": "John",
  "items": [
    {
      "menuItemId": "clq1234567890",
      "quantity": 2,
      "specialInstructions": "No olives"
    }
  ]
}

// Response: 201 Created
{
  "data": {
    "id": "clq0987654321",
    "tableNumber": 5,
    "serverName": "John",
    "status": "PENDING",
    "createdAt": "2026-01-13T12:30:00Z",
    "updatedAt": "2026-01-13T12:30:00Z",
    "items": [...]
  }
}
```

### Data Model Transformation

**OrderContext → API Payload:**
```typescript
// OrderContext state (local)
interface OrderItem {
  menuItemId: string;
  menuItem: MenuItem;
  quantity: number;
  specialInstructions: string | null;
}

// Must transform to API format:
interface CreateOrderItemInput {
  menuItemId: string;
  quantity: number;
  specialInstructions?: string;
}

// Transformation:
const apiItems = items.map(item => ({
  menuItemId: item.menuItemId,
  quantity: item.quantity,
  specialInstructions: item.specialInstructions || undefined,
}));
```

### UI/UX Specifications

[Source: docs/front-end-spec.md#Screen 3: Staff — Order Entry Screen]

**Button Layout:**
```
┌───────────────────────────┐
│  TOTAL:          $54.96   │
│                           │
│  [Clear] [Submit Order ▶] │
└───────────────────────────┘
```

**Submit Button States:**
- Enabled: `bg-blue-600 text-white hover:bg-blue-700`
- Disabled: `bg-gray-300 text-gray-500 cursor-not-allowed`
- Loading: `bg-blue-600 text-white opacity-75` with "Submitting..." text

**Clear Button States:**
- Default: `text-gray-600 hover:text-gray-900 border border-gray-300`
- Disabled during submission: `opacity-50 cursor-not-allowed`

**Interaction Notes:**
[Source: docs/front-end-spec.md#Screen 3]
- Submit disabled until: table #, server name, at least 1 item
- Clear shows confirmation if items exist
- Touch targets minimum 44x44px

### Component Structure

**Updated OrderBuilder Component:**
```typescript
function OrderBuilder(): JSX.Element {
  const { items, tableNumber, serverName, clearOrder } = useOrder();
  const { createOrder, isSubmitting, error } = useCreateOrder();
  const { showToast } = useToast();
  const navigate = useNavigate();
  
  const canSubmit = items.length > 0 && tableNumber !== null && serverName.trim() !== '';
  
  // ... existing render code ...
  
  // Add footer with buttons
}
```

### Routing

[Source: docs/architecture.md#Project Structure]

**Routes to add/modify:**
- `/staff/orders` - Active Orders List (new page, placeholder for Story 2.8)
- `/staff/orders/new` - Already exists (NewOrderPage)

### File Locations

- Hook: `packages/web/src/hooks/useCreateOrder.ts`
- Page: `packages/web/src/pages/staff/OrdersPage.tsx`
- Tests: `packages/web/tests/hooks/useCreateOrder.test.ts`
- Router: `packages/web/src/router/index.tsx`

### Existing Toast System

[Source: Story 1.8 implementation]

```typescript
import { useToast } from '../../contexts/ToastContext';

const { showToast } = useToast();
showToast('Order #123 submitted to kitchen', 'success');
showToast('Failed to submit order', 'error');
```

ToastProvider is already in App.tsx wrapping the application.

## Testing

### Testing Standards

[Source: docs/architecture.md#Testing Strategy]

**Frontend Component Tests:**
- Framework: Vitest + React Testing Library
- Location: `packages/web/tests/`
- Pattern: `{component-name}.test.tsx`
- Use `userEvent.setup()` for user interactions (required to prevent hangs)
- Mock API calls using `vi.mock()`
- Mock `useNavigate` from react-router-dom for navigation tests

**Hook Tests:**
- Location: `packages/web/tests/hooks/`
- Pattern: `{hook-name}.test.ts`
- Use `renderHook` from `@testing-library/react`
- Mock fetch/api calls

**Test File Naming:**
- Components: `packages/web/tests/components/{ComponentName}.test.tsx`
- Pages: `packages/web/tests/pages/{PageName}.test.tsx`
- Hooks: `packages/web/tests/hooks/{hookName}.test.ts`

### Key Test Scenarios

1. **Submit Button Validation:**
   - Button disabled when items.length === 0
   - Button disabled when tableNumber === null
   - Button disabled when serverName === ''
   - Button enabled when all conditions met

2. **Submit Flow:**
   - API called with correct payload format
   - Success toast shows order ID
   - Navigation to /staff/orders on success
   - Error toast on API failure
   - Order data preserved on error

3. **Clear Flow:**
   - Confirmation dialog shown when items exist
   - No confirmation when order empty
   - Context cleared on confirm

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 0.1 | Initial story draft | Bob (SM) |
