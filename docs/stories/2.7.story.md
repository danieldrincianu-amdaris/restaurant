# Story 2.7: Staff Order Submission

## Status: Ready for review

## Story

**As a** Restaurant Staff user,  
**I want** to submit completed orders to the kitchen,  
**so that** food preparation can begin.

## Acceptance Criteria

1. "Submit Order" button visible when order has table #, server name, and at least one item
2. Button disabled with visual indicator if requirements not met
3. Submit creates order via API and redirects to active orders list
4. Success toast notification: "Order #X submitted to kitchen"
5. Error displays message without losing order data
6. Clear order button resets order builder (with confirmation if items exist)
7. Submitted order status is PENDING

## Tasks / Subtasks

- [x] **Task 1: Create Order Submission Hook** (AC: 3, 4, 5, 7)
  - [x] Create `packages/web/src/hooks/useCreateOrder.ts`
  - [x] Implement `createOrder` function that calls `POST /api/orders`
  - [x] Handle loading state (`isSubmitting`)
  - [x] Handle error state with error message
  - [x] Return created order data on success
  - [x] Format OrderContext items to API CreateOrderInput format

- [x] **Task 2: Add Submit Order Button to OrderBuilder** (AC: 1, 2)
  - [x] Add "Submit Order" button at bottom of OrderBuilder component
  - [x] Implement validation logic: require tableNumber, serverName, at least 1 item
  - [x] Disable button when validation fails with visual indicator (opacity, cursor)
  - [x] Show tooltip or hint text explaining why button is disabled
  - [x] Style button with primary action colors (blue-600 bg, white text)
  - [x] Touch-friendly: minimum 44x44px height

- [x] **Task 3: Implement Submit Order Flow** (AC: 3, 4, 5, 7)
  - [x] Wire Submit button to useCreateOrder hook
  - [x] On click: show loading state on button ("Submitting...")
  - [x] On success: show success toast "Order #X submitted to kitchen"
  - [x] On success: clear order context via `clearOrder()`
  - [x] On success: redirect to `/staff/orders` using `useNavigate`
  - [x] On error: show error toast with API error message
  - [x] On error: preserve order data (no clear, no redirect)

- [x] **Task 4: Add Clear Order Button** (AC: 6)
  - [x] Add "Clear" button next to Submit button
  - [x] Style as secondary/ghost button (gray text, no fill)
  - [x] If order has items: show ConfirmDialog before clearing
  - [x] Confirmation message: "Clear this order? All items will be removed."
  - [x] On confirm: call `clearOrder()` from OrderContext
  - [x] If order is empty: clear without confirmation

- [x] **Task 5: Create Active Orders List Page Stub** (AC: 3)
  - [x] Create `packages/web/src/pages/staff/OrdersPage.tsx` (placeholder)
  - [x] Add route `/staff/orders` to router
  - [x] Display simple "Active Orders" header and "Coming soon" message
  - [x] Include "New Order" button linking to `/staff/orders/new`

- [x] **Task 6: Write useCreateOrder Hook Tests** (AC: 3, 4, 5, 7)
  - [x] Create `packages/web/tests/hooks/useCreateOrder.test.ts`
  - [x] Test successful order creation returns order data
  - [x] Test loading state is true during submission
  - [x] Test error state populated on API failure
  - [x] Test proper API payload format

- [x] **Task 7: Write OrderBuilder Submit Integration Tests** (AC: 1, 2, 3, 4, 5, 6)
  - [x] Update `packages/web/tests/components/OrderBuilder.test.tsx`
  - [x] Test Submit button disabled when no items
  - [x] Test Submit button disabled when no table number
  - [x] Test Submit button disabled when no server name
  - [x] Test Submit button enabled when all requirements met
  - [x] Test Clear button shows confirmation when items exist
  - [x] Test Clear button clears without confirmation when empty

- [x] **Task 8: Write NewOrderPage Submission Integration Tests** (AC: 3, 4, 5)
  - [x] Update `packages/web/tests/pages/NewOrderPage.test.tsx`
  - [x] Test successful submission flow (mock API, verify toast, verify redirect)
  - [x] Test error handling (mock API failure, verify error toast, data preserved)

## Dev Notes

### Previous Story Context (Story 2.6)

Story 2.6 completed the OrderBuilder component with:
- OrderItemRow with quantity controls (+/-)
- SpecialInstructionsModal for per-item instructions
- ConfirmDialog component for confirmations
- All wired to OrderContext

**Key Files from Story 2.6:**
- `packages/web/src/components/staff/OrderBuilder.tsx` - MODIFY to add Submit/Clear buttons
- `packages/web/src/components/staff/OrderItemRow.tsx` - No changes needed
- `packages/web/src/components/staff/SpecialInstructionsModal.tsx` - No changes needed
- `packages/web/src/components/ui/ConfirmDialog.tsx` - REUSE for Clear confirmation
- `packages/web/src/contexts/OrderContext.tsx` - Use existing clearOrder()

### API Specifications

[Source: docs/architecture.md#Order Endpoints]

**POST /api/orders - Create Order:**
```json
// Request Body
{
  "tableNumber": 5,
  "serverName": "John",
  "items": [
    {
      "menuItemId": "clq1234567890",
      "quantity": 2,
      "specialInstructions": "No olives"
    }
  ]
}

// Response: 201 Created
{
  "data": {
    "id": "clq0987654321",
    "tableNumber": 5,
    "serverName": "John",
    "status": "PENDING",
    "createdAt": "2026-01-13T12:30:00Z",
    "updatedAt": "2026-01-13T12:30:00Z",
    "items": [...]
  }
}
```

### Data Model Transformation

**OrderContext → API Payload:**
```typescript
// OrderContext state (local)
interface OrderItem {
  menuItemId: string;
  menuItem: MenuItem;
  quantity: number;
  specialInstructions: string | null;
}

// Must transform to API format:
interface CreateOrderItemInput {
  menuItemId: string;
  quantity: number;
  specialInstructions?: string;
}

// Transformation:
const apiItems = items.map(item => ({
  menuItemId: item.menuItemId,
  quantity: item.quantity,
  specialInstructions: item.specialInstructions || undefined,
}));
```

### UI/UX Specifications

[Source: docs/front-end-spec.md#Screen 3: Staff — Order Entry Screen]

**Button Layout:**
```
┌───────────────────────────┐
│  TOTAL:          $54.96   │
│                           │
│  [Clear] [Submit Order ▶] │
└───────────────────────────┘
```

**Submit Button States:**
- Enabled: `bg-blue-600 text-white hover:bg-blue-700`
- Disabled: `bg-gray-300 text-gray-500 cursor-not-allowed`
- Loading: `bg-blue-600 text-white opacity-75` with "Submitting..." text

**Clear Button States:**
- Default: `text-gray-600 hover:text-gray-900 border border-gray-300`
- Disabled during submission: `opacity-50 cursor-not-allowed`

**Interaction Notes:**
[Source: docs/front-end-spec.md#Screen 3]
- Submit disabled until: table #, server name, at least 1 item
- Clear shows confirmation if items exist
- Touch targets minimum 44x44px

### Component Structure

**Updated OrderBuilder Component:**
```typescript
function OrderBuilder(): JSX.Element {
  const { items, tableNumber, serverName, clearOrder } = useOrder();
  const { createOrder, isSubmitting, error } = useCreateOrder();
  const { showToast } = useToast();
  const navigate = useNavigate();
  
  const canSubmit = items.length > 0 && tableNumber !== null && serverName.trim() !== '';
  
  // ... existing render code ...
  
  // Add footer with buttons
}
```

### Routing

[Source: docs/architecture.md#Project Structure]

**Routes to add/modify:**
- `/staff/orders` - Active Orders List (new page, placeholder for Story 2.8)
- `/staff/orders/new` - Already exists (NewOrderPage)

### File Locations

- Hook: `packages/web/src/hooks/useCreateOrder.ts`
- Page: `packages/web/src/pages/staff/OrdersPage.tsx`
- Tests: `packages/web/tests/hooks/useCreateOrder.test.ts`
- Router: `packages/web/src/router/index.tsx`

### Existing Toast System

[Source: Story 1.8 implementation]

```typescript
import { useToast } from '../../contexts/ToastContext';

const { showToast } = useToast();
showToast('Order #123 submitted to kitchen', 'success');
showToast('Failed to submit order', 'error');
```

ToastProvider is already in App.tsx wrapping the application.

## Testing

### Testing Standards

[Source: docs/architecture.md#Testing Strategy]

**Frontend Component Tests:**
- Framework: Vitest + React Testing Library
- Location: `packages/web/tests/`
- Pattern: `{component-name}.test.tsx`
- Use `userEvent.setup()` for user interactions (required to prevent hangs)
- Mock API calls using `vi.mock()`
- Mock `useNavigate` from react-router-dom for navigation tests

**Hook Tests:**
- Location: `packages/web/tests/hooks/`
- Pattern: `{hook-name}.test.ts`
- Use `renderHook` from `@testing-library/react`
- Mock fetch/api calls

**Test File Naming:**
- Components: `packages/web/tests/components/{ComponentName}.test.tsx`
- Pages: `packages/web/tests/pages/{PageName}.test.tsx`
- Hooks: `packages/web/tests/hooks/{hookName}.test.ts`

### Key Test Scenarios

1. **Submit Button Validation:**
   - Button disabled when items.length === 0
   - Button disabled when tableNumber === null
   - Button disabled when serverName === ''
   - Button enabled when all conditions met

2. **Submit Flow:**
   - API called with correct payload format
   - Success toast shows order ID
   - Navigation to /staff/orders on success
   - Error toast on API failure
   - Order data preserved on error

3. **Clear Flow:**
   - Confirmation dialog shown when items exist
   - No confirmation when order empty
   - Context cleared on confirm

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 0.1 | Initial story draft | Bob (SM) |
| 2026-01-14 | 1.0 | Story completed - All 8 tasks implemented and tested (137/137 tests passing) | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4.5

### File List
**Created:**
- `packages/web/src/hooks/useCreateOrder.ts` - Order submission hook with API integration
- `packages/web/src/pages/staff/OrdersPage.tsx` - Active orders list placeholder
- `packages/web/tests/hooks/useCreateOrder.test.ts` - Hook tests (6/6 passing)

**Modified:**
- `packages/web/src/components/staff/OrderBuilder.tsx` - Added Submit/Clear buttons with full submission flow
- `packages/web/src/router/index.tsx` - Added /staff/orders route
- `packages/web/tests/components/OrderBuilder.test.tsx` - Added 6 new tests (14/14 passing)
- `packages/web/tests/pages/NewOrderPage.test.tsx` - Added 2 integration tests (9/9 passing)

### Completion Notes
- All 7 Acceptance Criteria validated through tests
- Submit button properly validates table, server, and items
- Success flow: API call → toast → clearOrder → redirect to /staff/orders
- Error flow: toast → preserve data (no clear, no redirect)
- Clear button with confirmation dialog for non-empty orders
- Full test coverage: 137 tests passing across 18 test files
- No regressions introduced

## QA Results

### Review Date: 2026-01-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - This implementation demonstrates strong architectural decisions, comprehensive test coverage, and production-ready error handling. The code is clean, maintainable, and follows React best practices.

**Strengths:**
- Custom hook pattern (`useCreateOrder`) properly encapsulates API logic with clear state management
- Clean separation of concerns: hook handles API, component handles UX
- Proper TypeScript typing throughout with no `any` types
- Excellent error handling preserves user data on failure
- Smart validation logic prevents invalid submissions
- Touch-friendly UI (44px min height on buttons)
- Comprehensive test coverage at all levels (hook, component, integration)

**Code Quality Highlights:**
- `useCreateOrder.ts`: Clean async/await patterns, proper error propagation, clear state management
- `OrderBuilder.tsx`: Well-structured component with logical flow, proper use of React hooks
- Test files: Excellent use of userEvent.setup(), proper async/await patterns, clear test naming

### Refactoring Performed

**No refactoring needed.** The implementation is clean and production-ready as-is. The developer followed best practices:
- Proper hook extraction for reusability
- Clean component structure
- Appropriate state management
- Excellent test patterns

### Requirements Traceability

**AC 1: Submit button visible with requirements**
- **Given** order builder is displayed
- **When** order has table number, server name, and at least one item  
- **Then** Submit Order button is visible and enabled
- **Test Coverage:** `OrderBuilder.test.tsx` - "Submit button is enabled when all requirements are met"

**AC 2: Button disabled with visual indicator**
- **Given** order builder is displayed
- **When** requirements are not met (no items, no table, or no server)
- **Then** Submit button is disabled with opacity and cursor styling
- **Test Coverage:** `OrderBuilder.test.tsx` - "Submit button is disabled when no items/table/server" (3 tests)

**AC 3: Submit creates order and redirects**
- **Given** valid order ready for submission
- **When** user clicks Submit Order button
- **Then** API POST /orders is called and user redirects to /staff/orders
- **Test Coverage:** `NewOrderPage.test.tsx` - "successful submission flow - shows toast and redirects"

**AC 4: Success toast notification**
- **Given** order submitted successfully
- **When** API returns order data
- **Then** toast shows "Order #<id> submitted to kitchen"
- **Test Coverage:** `NewOrderPage.test.tsx` - integration test validates toast message with order ID

**AC 5: Error displays without losing data**
- **Given** order submission fails
- **When** API returns error
- **Then** error toast shown, order data preserved (no clear, no redirect)
- **Test Coverage:** `NewOrderPage.test.tsx` - "error handling - shows error toast and preserves data"

**AC 6: Clear order with confirmation**
- **Given** order has items
- **When** user clicks Clear button
- **Then** confirmation dialog shown, order cleared on confirm
- **Test Coverage:** `OrderBuilder.test.tsx` - "Clear button shows confirmation/clears order when confirmed"

**AC 7: Submitted order status is PENDING**
- **Given** order created via API
- **When** API response received
- **Then** order status is PENDING
- **Test Coverage:** `useCreateOrder.test.ts` - validates API response structure includes PENDING status

### Compliance Check

- ✓ **Coding Standards:** Clean TypeScript, proper async/await, no console.log in production code
- ✓ **Project Structure:** Files in correct locations per monorepo structure
- ✓ **Testing Strategy:** Comprehensive coverage at hook, component, and integration levels (137/137 passing)
- ✓ **All ACs Met:** All 7 acceptance criteria fully implemented and validated

### Test Architecture Assessment

**Test Coverage: EXCELLENT** - Multi-layered approach with appropriate test levels:

1. **Hook Tests** (`useCreateOrder.test.ts`): 6 tests covering unit logic
   - API integration, state management, error handling
   - Proper use of `renderHook` and async testing patterns

2. **Component Tests** (`OrderBuilder.test.tsx`): 14 tests covering UI logic  
   - Button state validation, user interactions, confirmation flows
   - Excellent use of `userEvent.setup()` pattern (prevents test hangs)

3. **Integration Tests** (`NewOrderPage.test.tsx`): 9 tests covering full flows
   - End-to-end submission flow with mocked API
   - Error handling with data preservation validation
   - Navigation verification

**Test Quality Strengths:**
- Clear Given-When-Then structure in test names
- Proper async/await and waitFor usage
- Mock isolation (vi.mock for API, contexts)
- No test interdependencies
- Fast execution (10.25s for 137 tests)

**Test Maintainability:** High - Tests are readable, well-named, and use consistent patterns.

### Improvements Checklist

**All items complete - no recommendations for changes:**

- [x] ✓ Clean hook extraction (useCreateOrder) - excellent pattern
- [x] ✓ Comprehensive test coverage at all levels
- [x] ✓ Proper error handling with user-friendly messages
- [x] ✓ Smart button state management with validation
- [x] ✓ Touch-friendly UI (44px+ button heights)
- [x] ✓ Confirmation dialogs for destructive actions
- [x] ✓ Data preservation on errors (AC 5)
- [x] ✓ Clear separation of concerns

### Security Review

**Status: PASS** - No security concerns identified for this story scope.

- ✓ No sensitive data logged or exposed
- ✓ API errors sanitized before display
- ✓ Input validation present (tableNumber type, serverName trim)
- ✓ No XSS vulnerabilities (React escapes by default)

**Note:** Rate limiting and auth are out of scope for this story but should be addressed at API level in future stories.

### Performance Considerations

**Status: PASS** - No performance concerns for this feature.

- ✓ Efficient state updates (useMemo for total calculation)
- ✓ No unnecessary re-renders
- ✓ Fast test execution (10.25s for 137 tests)
- ✓ Proper async handling prevents UI blocking

**Optimization note:** The running total calculation uses `useMemo` correctly to avoid recalculation on every render.

### Non-Functional Requirements

**Accessibility:** Good foundation, could enhance further (out of scope):
- ✓ Semantic HTML (labels, buttons)
- ✓ Keyboard accessible (form inputs, buttons)
- ✓ Clear visual feedback (disabled states, loading states)
- Future: ARIA labels for screen readers, focus management

**Usability:** Excellent
- ✓ Clear error messages
- ✓ Confirmation for destructive actions
- ✓ Loading states during async operations
- ✓ Touch-friendly button sizes (44px min-height)

**Maintainability:** Excellent
- ✓ Clean code structure
- ✓ Proper TypeScript typing
- ✓ Comprehensive test coverage
- ✓ Clear separation of concerns

### Files Modified During Review

**None** - No refactoring was needed. All implementation files are production-ready.

### Gate Status

**Gate: PASS** → [docs/qa/gates/2.7-staff-order-submission.yml](../qa/gates/2.7-staff-order-submission.yml)

**Decision Rationale:**
- All 7 acceptance criteria fully implemented and validated
- Comprehensive test coverage (hook + component + integration)
- Excellent code quality with clean architecture
- No security or performance concerns
- Production-ready error handling
- All tests passing (137/137)

### Recommended Status

**✓ Ready for Done** - Story fully complete with no concerns or required changes.

This implementation sets a high bar for quality. The multi-layered testing approach (hook → component → integration) provides strong confidence in the implementation. The error handling with data preservation (AC 5) shows careful attention to user experience.
