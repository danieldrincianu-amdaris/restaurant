# Story 1.2: Database Setup & Menu Item Schema

## Status: Ready for Review

## Story

**As a** developer,  
**I want** the database configured with the menu item schema,  
**so that** I can persist and query menu data.

## Acceptance Criteria

1. PostgreSQL database configured (local dev via Docker or direct install)
2. Prisma (or TypeORM) configured with database connection
3. Menu Item model created with fields: id, name, price, ingredients (array), imageUrl, category, foodType, available, createdAt, updatedAt
4. Category enum defined: APPETIZER, MAIN, DRINK, DESSERT
5. Migration script creates the menu_items table
6. Seed script populates 5-10 sample menu items for development
7. Database connection validated on API startup with graceful error if unavailable

## Tasks / Subtasks

- [x] **Task 1: Setup PostgreSQL with Docker** (AC: 1)
  - [x] Create `docker-compose.dev.yml` with PostgreSQL 15+ service
  - [x] Configure volume for data persistence
  - [x] Add healthcheck for database readiness
  - [x] Document startup in README

- [x] **Task 2: Install and Configure Prisma** (AC: 2)
  - [x] Install `prisma` and `@prisma/client` in api package
  - [x] Initialize Prisma with `npx prisma init`
  - [x] Configure `DATABASE_URL` in `.env` and `.env.example`
  - [x] Add Prisma scripts to `packages/api/package.json` (generate, migrate, studio, seed)

- [x] **Task 3: Define Menu Item Schema** (AC: 3, 4)
  - [x] Create `packages/api/prisma/schema.prisma` with generator and datasource
  - [x] Define `Category` enum: APPETIZER, MAIN, DRINK, DESSERT
  - [x] Define `FoodType` enum: MEAT, PASTA, PIZZA, SEAFOOD, VEGETARIAN, SALAD, SOUP, SANDWICH, COFFEE, BEVERAGE, OTHER
  - [x] Define `MenuItem` model with all required fields
  - [x] Configure table mapping to `menu_items`
  - [x] Add appropriate indexes

- [x] **Task 4: Create Migration** (AC: 5)
  - [x] Run `npx prisma migrate dev --name init_menu_items`
  - [x] Verify migration file created in `prisma/migrations/`
  - [x] Verify table created in PostgreSQL

- [x] **Task 5: Create Seed Script** (AC: 6)
  - [x] Create `packages/api/prisma/seed.ts` with 8-10 sample menu items
  - [x] Include variety across categories and food types
  - [x] Configure seed script in `package.json` (prisma.seed)
  - [x] Run seed and verify data in database

- [x] **Task 6: Create Prisma Client Singleton** (AC: 2)
  - [x] Create `packages/api/src/lib/prisma.ts` with singleton pattern
  - [x] Handle connection in development (avoid multiple clients)
  - [x] Export typed PrismaClient instance

- [x] **Task 7: Validate Database Connection on Startup** (AC: 7)
  - [x] Add database connection check in `packages/api/src/index.ts`
  - [x] Log successful connection message
  - [x] Handle connection failure gracefully with clear error message
  - [x] Ensure server doesn't crash if DB unavailable (log and exit with code 1)

- [x] **Task 8: Update Shared Types** (AC: 3, 4)
  - [x] Create `packages/shared/src/types/menu.ts` with Category, FoodType enums
  - [x] Create MenuItem interface matching Prisma model
  - [x] Create CreateMenuItemInput and UpdateMenuItemInput interfaces
  - [x] Export from `packages/shared/src/index.ts`

- [x] **Task 9: Write Database Integration Tests** (AC: 2, 3, 5)
  - [x] Create `packages/api/tests/db.test.ts` for connection test
  - [x] Test Prisma client can connect and query
  - [x] Test MenuItem model CRUD operations work

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 Completion Notes]

- pnpm workspaces configured and functional
- TypeScript strict mode enabled across all packages
- Express server running on port 3001 (configurable via PORT env)
- Shared package builds to both CJS and ESM formats using tsup
- Web package placeholder scripts in place until frontend implementation

### Database Configuration
[Source: architecture.md#Tech Stack, architecture.md#Deployment Configuration]

| Technology | Version | Purpose |
|------------|---------|---------|
| PostgreSQL | 15+ | Relational database |
| Prisma | 5.7+ | Type-safe ORM |

**DATABASE_URL format:**
```
postgresql://restaurant:your_password@localhost:5432/restaurant
```

### Prisma Schema
[Source: architecture.md#Data Models]

```prisma
// packages/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Category {
  APPETIZER
  MAIN
  DRINK
  DESSERT
}

enum FoodType {
  MEAT
  PASTA
  PIZZA
  SEAFOOD
  VEGETARIAN
  SALAD
  SOUP
  SANDWICH
  COFFEE
  BEVERAGE
  OTHER
}

model MenuItem {
  id          String     @id @default(cuid())
  name        String
  price       Decimal    @db.Decimal(10, 2)
  ingredients String[]
  imageUrl    String?
  category    Category
  foodType    FoodType   @default(OTHER)
  available   Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("menu_items")
}
```

**Note:** The `OrderItem` relation should be omitted in this story since Order schema is Story 2.1.

### Shared TypeScript Interfaces
[Source: architecture.md#Shared TypeScript Interfaces]

```typescript
// packages/shared/src/types/menu.ts

export enum Category {
  APPETIZER = 'APPETIZER',
  MAIN = 'MAIN',
  DRINK = 'DRINK',
  DESSERT = 'DESSERT',
}

export enum FoodType {
  MEAT = 'MEAT',
  PASTA = 'PASTA',
  PIZZA = 'PIZZA',
  SEAFOOD = 'SEAFOOD',
  VEGETARIAN = 'VEGETARIAN',
  SALAD = 'SALAD',
  SOUP = 'SOUP',
  SANDWICH = 'SANDWICH',
  COFFEE = 'COFFEE',
  BEVERAGE = 'BEVERAGE',
  OTHER = 'OTHER',
}

export interface MenuItem {
  id: string;
  name: string;
  price: number;
  ingredients: string[];
  imageUrl: string | null;
  category: Category;
  foodType: FoodType;
  available: boolean;
  createdAt: string;
  updatedAt: string;
}

export interface CreateMenuItemInput {
  name: string;
  price: number;
  ingredients: string[];
  imageUrl?: string;
  category: Category;
  foodType?: FoodType;
  available?: boolean;
}

export interface UpdateMenuItemInput extends Partial<CreateMenuItemInput> {}
```

### Docker Compose for Development
[Source: architecture.md#Docker Compose (Production)]

Create `docker-compose.dev.yml` for local PostgreSQL:

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: restaurant-db-dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: restaurant
      POSTGRES_PASSWORD: restaurant_dev
      POSTGRES_DB: restaurant
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U restaurant"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_dev_data:
```

### Prisma Client Singleton Pattern
[Source: architecture.md#Backend Architecture]

```typescript
// packages/api/src/lib/prisma.ts
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  });

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

### File Locations
[Source: architecture.md#Project Structure]

| File | Location |
|------|----------|
| Prisma Schema | `packages/api/prisma/schema.prisma` |
| Migrations | `packages/api/prisma/migrations/` |
| Seed Script | `packages/api/prisma/seed.ts` |
| Prisma Client | `packages/api/src/lib/prisma.ts` |
| Shared Types | `packages/shared/src/types/menu.ts` |
| DB Tests | `packages/api/tests/db.test.ts` |

## Testing

### Testing Standards
[Source: architecture.md#Testing Strategy]

- **Framework:** Vitest 1.0+
- **Test Location:** `packages/api/tests/`
- **Integration Testing:** Test Prisma operations against real database

### Test Pattern for Database

```typescript
// packages/api/tests/db.test.ts
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { prisma } from '../src/lib/prisma';

describe('Database Connection', () => {
  it('should connect to database', async () => {
    const result = await prisma.$queryRaw`SELECT 1 as connected`;
    expect(result).toBeDefined();
  });
});

describe('MenuItem Model', () => {
  it('should create a menu item', async () => {
    const item = await prisma.menuItem.create({
      data: {
        name: 'Test Item',
        price: 9.99,
        ingredients: ['test'],
        category: 'MAIN',
      },
    });
    expect(item.id).toBeDefined();
    
    // Cleanup
    await prisma.menuItem.delete({ where: { id: item.id } });
  });
});
```

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Completion Notes
- All 9 tasks implemented successfully
- PostgreSQL running in Docker container (postgres:15-alpine)
- Prisma 7.x with pg adapter pattern (required for Prisma 7.x direct connections)
- MenuItem model with Category and FoodType enums
- Migration applied and seed data populated (10 sample menu items)
- Prisma client singleton with connection/disconnection helpers
- API server validates database connection on startup with graceful shutdown
- Shared types exported for frontend consumption
- 6 database integration tests added (all passing)
- Total test suite: 10/10 passing

### Debug Log
- Docker Desktop not initially running - user started it
- Prisma 7.x breaking changes required adapter pattern instead of direct URL in schema
- Seed script needed manual fix due to PowerShell escaping issues
- Missing @types/pg installed for TypeScript compilation

### File List
| File | Action | Description |
|------|--------|-------------|
| docker-compose.dev.yml | Created | PostgreSQL 15 container with healthcheck and volume |
| packages/api/prisma/schema.prisma | Created | MenuItem model with Category/FoodType enums |
| packages/api/prisma/migrations/20260113105519_init_menu_items/migration.sql | Created | Initial migration for menu_items table |
| packages/api/prisma.config.ts | Created | Prisma configuration for pg adapter |
| packages/api/prisma/seed.ts | Created | Seed script with 10 sample menu items |
| packages/api/src/lib/prisma.ts | Created | Prisma client singleton with pg adapter |
| packages/api/tests/db.test.ts | Created | 6 database integration tests |
| packages/shared/src/types/menu.ts | Created | Category, FoodType enums and MenuItem interfaces |
| packages/api/package.json | Modified | Added prisma, @prisma/client, @prisma/adapter-pg, pg dependencies |
| packages/api/.env | Modified | Added DATABASE_URL |
| .env.example | Modified | Added DATABASE_URL template |
| README.md | Modified | Added Docker/database setup instructions |
| packages/api/src/index.ts | Modified | Added database connection validation on startup |
| packages/shared/src/types/index.ts | Modified | Added menu types export |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 0.1 | Initial story draft | Bob (SM) |
| 2026-01-13 | 0.2 | Implementation complete - all tasks done | James (Dev) |