# Story 3.5: Kitchen Order Cards

## Status: Done

## Story

**As a** Kitchen Staff user,  
**I want** order cards showing all relevant details,  
**so that** I can prepare orders correctly.

## Acceptance Criteria

1. Each order displayed as a card within its status column
2. Card header shows: Order ID, Table number, time elapsed since creation
3. Card body shows: list of items with quantities and special instructions
4. Special instructions highlighted/emphasized (different background or icon)
5. Server name displayed (for communication if questions arise)
6. Time elapsed updates live (every minute) without page refresh
7. Cards have consistent size with scrollable content if many items
8. Visual indicator for orders with special instructions (icon or badge)

## Tasks / Subtasks

- [x] **Task 1: Create KitchenOrderCard component** (AC: 1, 2, 5, 7)
  - [x] 1.1 Create `packages/web/src/components/kitchen/KitchenOrderCard.tsx`
  - [x] 1.2 Card header with order ID (last 6 chars), table number, status icon
  - [x] 1.3 Time elapsed display with timer icon (e.g., "â±ï¸ 12 min")
  - [x] 1.4 Server name in card footer
  - [x] 1.5 Consistent card sizing with max-height and overflow scroll
  - [x] 1.6 Status-specific left border color (from statusConfig)
  - [x] 1.7 Touch-friendly sizing (min 44px tap targets)

- [x] **Task 2: Create OrderItemsList component** (AC: 3, 4, 8)
  - [x] 2.1 Create `packages/web/src/components/kitchen/OrderItemsList.tsx`
  - [x] 2.2 Display each item with quantity prefix (e.g., "2x Margherita Pizza")
  - [x] 2.3 Show special instructions below item with emphasized styling (ğŸ—’ï¸ icon, bg-amber-50)
  - [x] 2.4 Visual badge/indicator when order has any special instructions
  - [x] 2.5 Handle long item names with text truncation or wrapping
  - [x] 2.6 Scrollable content area for orders with many items

- [x] **Task 3: Implement live time elapsed utility** (AC: 6)
  - [x] 3.1 Create `packages/web/src/lib/timeUtils.ts` with `formatElapsedTime(createdAt)` function
  - [x] 3.2 Return human-readable format: "X min" or "Xh Ym" for longer durations
  - [x] 3.3 Create `useElapsedTime(createdAt)` hook with auto-update every minute
  - [x] 3.4 Use `useEffect` with `setInterval` for live updates
  - [x] 3.5 Cleanup interval on component unmount

- [x] **Task 4: Integrate KitchenOrderCard into StatusColumn** (AC: 1)
  - [x] 4.1 Replace placeholder div with `<KitchenOrderCard />` component
  - [x] 4.2 Pass order data, status, and any onClick handler as props
  - [x] 4.3 Maintain scrollable column content area
  - [x] 4.4 Ensure cards have proper spacing (space-y-3)

- [x] **Task 5: Write unit tests for KitchenOrderCard** (AC: 1, 2, 5, 6, 7)
  - [x] 5.1 Create `packages/web/tests/components/kitchen/KitchenOrderCard.test.tsx`
  - [x] 5.2 Test displays order ID (last 6 characters)
  - [x] 5.3 Test displays table number
  - [x] 5.4 Test displays server name
  - [x] 5.5 Test displays time elapsed
  - [x] 5.6 Test status-specific border color applied
  - [x] 5.7 Test onClick handler called when card clicked
  - [x] 5.8 Test card has proper accessibility attributes

- [x] **Task 6: Write unit tests for OrderItemsList** (AC: 3, 4, 8)
  - [x] 6.1 Create `packages/web/tests/components/kitchen/OrderItemsList.test.tsx`
  - [x] 6.2 Test displays all items with quantities
  - [x] 6.3 Test displays special instructions with emphasis styling
  - [x] 6.4 Test shows indicator badge when order has special instructions
  - [x] 6.5 Test handles empty items array
  - [x] 6.6 Test renders menu item names correctly

- [x] **Task 7: Write unit tests for timeUtils** (AC: 6)
  - [x] 7.1 Create `packages/web/tests/lib/timeUtils.test.ts`
  - [x] 7.2 Test `formatElapsedTime` returns "X min" for minutes
  - [x] 7.3 Test `formatElapsedTime` returns "Xh Ym" for hours
  - [x] 7.4 Test `formatElapsedTime` handles edge cases (0 minutes, just created)
  - [x] 7.5 Test `useElapsedTime` hook updates value over time (mock timers)

## Dev Notes

### Source Files to Create

```
packages/web/src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ kitchen/
â”‚       â”œâ”€â”€ KitchenOrderCard.tsx    # Full order card component
â”‚       â””â”€â”€ OrderItemsList.tsx      # Items list with special instructions
â””â”€â”€ lib/
    â””â”€â”€ timeUtils.ts                # Elapsed time formatting + hook

packages/web/tests/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ kitchen/
â”‚       â”œâ”€â”€ KitchenOrderCard.test.tsx
â”‚       â””â”€â”€ OrderItemsList.test.tsx
â””â”€â”€ lib/
    â””â”€â”€ timeUtils.test.ts
```

### Files to Modify

- `packages/web/src/components/kitchen/StatusColumn.tsx` - Replace placeholder cards with KitchenOrderCard

### Existing Types (from @restaurant/shared)

**Order Interface:**
```typescript
interface Order {
  id: string;
  tableNumber: number;
  serverName: string;
  status: OrderStatus;
  createdAt: string;  // ISO date string
  updatedAt: string;
  items: OrderItem[];
}
```

**OrderItem Interface:**
```typescript
interface OrderItem {
  id: string;
  orderId: string;
  menuItemId: string;
  quantity: number;
  specialInstructions: string | null;
  createdAt: string;
  menuItem?: MenuItem;
}
```

**MenuItem Interface (nested in OrderItem):**
```typescript
interface MenuItem {
  id: string;
  name: string;
  price: number;
  category: Category;
  foodType: FoodType;
  // ... other fields
}
```

### Existing StatusColumn Configuration

The `statusConfig` object already exists in `StatusColumn.tsx`:
```typescript
const statusConfig = {
  [OrderStatus.PENDING]: {
    icon: 'ğŸ”µ',
    label: 'Pending',
    bgColor: 'bg-blue-500',
    borderColor: 'border-blue-500',
    textColor: 'text-blue-600',
  },
  // ... other statuses
};
```

Consider extracting to shared config file or passing as prop.

### UI Wireframe Reference (from front-end-spec.md)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ #127 Table 5  â”‚  â† Order ID (last 6 chars) + Table number
â”‚ â±ï¸ 3 min      â”‚  â† Time elapsed with icon
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 2x Margherita â”‚  â† Items with quantities
â”‚ 1x Caesar     â”‚
â”‚ 1x Espresso   â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Server: John  â”‚  â† Server name footer
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Special Instructions Display:**
```
â”‚ 2x Margherita Pizza                    â”‚
â”‚    â””â”€ ğŸ—’ï¸ "No olives, extra cheese"    â”‚  â† Emphasized with icon + background
```

### Time Elapsed Formatting Rules

- `< 1 min`: "Just now" or "< 1 min"
- `1-59 min`: "X min"
- `60+ min`: "Xh Ym" (e.g., "1h 23m")
- Update every 60 seconds via hook

### Design Specifications

**Card Dimensions:**
- Min height: 120px
- Max height: 300px (with overflow scroll for content)
- Width: Fill column (flex-1)
- Padding: 16px (p-4)
- Border-left: 4px solid status color

**Typography:**
- Order ID: font-semibold, text-gray-800
- Table #: text-sm, text-gray-600
- Time elapsed: text-sm, text-gray-500
- Items: text-sm, text-gray-700
- Special instructions: text-xs, text-amber-800, bg-amber-50, rounded, px-2 py-1
- Server name: text-xs, text-gray-500

**Indicator Badge (for orders with special instructions):**
- Position: Top-right of card header
- Icon: ğŸ—’ï¸ or ğŸ“
- Alternative: Small dot or icon next to order ID

### Touch Target Guidelines

- Card itself should be tappable (onClick for future detail modal)
- Minimum touch target: 44x44px
- Cards should have hover/active states for visual feedback

### Testing Standards

**Test File Locations:**
- Component tests: `packages/web/tests/components/kitchen/`
- Utility tests: `packages/web/tests/lib/`

**Testing Framework:** Vitest + React Testing Library

**Test Patterns:**
```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, act } from '@testing-library/react';

// For time-based tests, use fake timers
beforeEach(() => {
  vi.useFakeTimers();
});

afterEach(() => {
  vi.useRealTimers();
});

// Advance time
act(() => {
  vi.advanceTimersByTime(60000); // 1 minute
});
```

**Run Tests:**
```bash
cd packages/web
pnpm test
```

### Integration with Story 3.4

Story 3.4 created:
- `KitchenPage.tsx` - Page container
- `KitchenBoard.tsx` - Board with 4 columns
- `StatusColumn.tsx` - Column with placeholder cards (to be updated)
- `orderFilters.ts` - Filtering utilities

This story replaces the placeholder cards in `StatusColumn.tsx` with full `KitchenOrderCard` components.

### Note on Story 3.6

Story 3.6 will add drag-and-drop functionality to these order cards using `@dnd-kit`. This story focuses on card display only - cards will be static (non-draggable) until Story 3.6.

## Testing

**Unit Tests Required:**
- KitchenOrderCard: rendering, data display, click handling, styling
- OrderItemsList: items rendering, special instructions emphasis, empty state
- timeUtils: elapsed time formatting, hook behavior with timer updates

**Integration Tests:**
- Verify KitchenOrderCard renders correctly within StatusColumn
- Verify live time updates work without memory leaks

**Manual Verification:**
- Navigate to `/kitchen` route
- Verify order cards show all details (ID, table, time, items, server)
- Verify special instructions are highlighted
- Wait 1+ minute and verify time elapsed updates
- Test on tablet-sized screen for touch friendliness

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2026-01-15 | 1.0 | Implementation complete | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None - Implementation proceeded without blocking issues.

### Completion Notes List
- Created `KitchenOrderCard.tsx` component with full order details display
- Created `OrderItemsList.tsx` component with special instructions emphasis and visual indicator
- Created `timeUtils.ts` with `formatElapsedTime()` function and `useElapsedTime()` hook for live updates
- Integrated KitchenOrderCard into StatusColumn, replacing placeholder cards
- All 36 new tests passing (18 KitchenOrderCard + 8 OrderItemsList + 10 timeUtils)
- Updated StatusColumn tests to work with new KitchenOrderCard component
- Total test suite: 303/303 passing
- Time elapsed updates every minute automatically
- Special instructions displayed with amber background and icon
- Cards have consistent sizing with min-height 120px, max-height 300px
- Touch-friendly with proper accessibility attributes (role, aria-label, tabIndex, keyboard support)

### File List

**Created Files:**
- `packages/web/src/components/kitchen/KitchenOrderCard.tsx` - Full order card with header, items, footer
- `packages/web/src/components/kitchen/OrderItemsList.tsx` - Items list with special instructions emphasis
- `packages/web/src/lib/timeUtils.ts` - Time elapsed formatting and hook
- `packages/web/tests/components/kitchen/KitchenOrderCard.test.tsx` - KitchenOrderCard tests (18 tests)
- `packages/web/tests/components/kitchen/OrderItemsList.test.tsx` - OrderItemsList tests (8 tests)
- `packages/web/tests/lib/timeUtils.test.ts` - timeUtils tests (10 tests)

**Modified Files:**
- `packages/web/src/components/kitchen/StatusColumn.tsx` - Replaced placeholder cards with KitchenOrderCard
- `packages/web/tests/components/kitchen/StatusColumn.test.tsx` - Updated tests for KitchenOrderCard integration

## QA Results

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** â­â­â­â­â­

Story 3.5 demonstrates exceptional implementation quality, building seamlessly on Story 3.4's foundation. The codebase exhibits:

- **Component Design Excellence**: Well-separated concerns with KitchenOrderCard (container), OrderItemsList (presentational), and timeUtils (utility)
- **React Best Practices**: Custom hook (useElapsedTime) with proper cleanup, lazy state initialization, effect dependency arrays correctly specified
- **Type Safety**: Full TypeScript coverage with proper interface definitions and optional chaining for safety
- **User Experience**: Live-updating time display, visual hierarchy with special instructions emphasis, accessibility-first design
- **Code Reusability**: timeUtils utilities designed for potential reuse beyond kitchen display
- **Performance Optimization**: Efficient time updates (60s interval, not excessive re-renders), minimal re-computation
- **Test Coverage**: Comprehensive 36 tests covering all edge cases including timer behavior, keyboard interactions, empty states

### Refactoring Performed

**No refactoring was necessary.** The implementation is production-ready with excellent code quality. Observations:

- Component composition is clean and maintainable
- No code duplication detected
- Proper separation of concerns (UI, logic, utilities)
- Accessibility implemented correctly from the start
- Time formatting logic appropriately isolated in utility functions

### Compliance Check

- **Coding Standards**: âœ“ PASS
  - TypeScript strict mode enabled
  - Consistent naming conventions throughout
  - JSDoc comments on utility functions
  - Proper React component structure with clear props interfaces
  
- **Project Structure**: âœ“ PASS
  - Files correctly placed in `components/kitchen/` and `lib/`
  - Tests mirror source structure perfectly
  - Proper modular organization
  
- **Testing Strategy**: âœ“ PASS
  - Unit tests for all components (KitchenOrderCard, OrderItemsList)
  - Utility function tests with edge cases (timeUtils)
  - Mock strategy appropriate (mocked useElapsedTime in component tests)
  - Timer tests using fake timers correctly
  - 36/36 tests passing for Story 3.5
  - All 8 ACs validated through tests
  
- **All ACs Met**: âœ“ PASS (see Requirements Traceability below)

### Requirements Traceability

**AC 1: Each order displayed as a card within its status column**
- **Implementation**: KitchenOrderCard component rendered in StatusColumn.tsx
- **Test Coverage**:
  - Given orders exist in a status column
  - When StatusColumn renders
  - Then KitchenOrderCard components displayed for each order
- **Status**: âœ“ VALIDATED

**AC 2: Card header shows: Order ID, Table number, time elapsed since creation**
- **Implementation**: Card header with order.id.slice(-6), tableNumber, and useElapsedTime hook
- **Test Coverage**:
  - Given order with ID, table number, and creation time
  - When KitchenOrderCard renders
  - Then displays "#def456" format, "Table 5", "12 min" elapsed time
- **Status**: âœ“ VALIDATED

**AC 3: Card body shows: list of items with quantities and special instructions**
- **Implementation**: OrderItemsList component with quantity prefix and special instructions display
- **Test Coverage**:
  - Given order with multiple items
  - When OrderItemsList renders
  - Then displays "2x Margherita Pizza" format with special instructions below
- **Status**: âœ“ VALIDATED

**AC 4: Special instructions highlighted/emphasized (different background or icon)**
- **Implementation**: Special instructions shown with ğŸ—’ï¸ icon, amber background (bg-amber-50), amber text (text-amber-800)
- **Test Coverage**:
  - Given item with special instructions
  - When OrderItemsList renders
  - Then special instructions have bg-amber-50 and text-amber-800 classes
- **Status**: âœ“ VALIDATED

**AC 5: Server name displayed (for communication if questions arise)**
- **Implementation**: Server name in card footer with "Server: {name}" format
- **Test Coverage**:
  - Given order with server name
  - When KitchenOrderCard renders
  - Then displays server name in footer
- **Status**: âœ“ VALIDATED

**AC 6: Time elapsed updates live (every minute) without page refresh**
- **Implementation**: useElapsedTime hook with setInterval(60000) for minute updates
- **Test Coverage**:
  - Given order created at specific time
  - When time advances by 1+ minutes
  - Then elapsed time display updates automatically
  - And cleanup occurs on unmount
- **Status**: âœ“ VALIDATED

**AC 7: Cards have consistent size with scrollable content if many items**
- **Implementation**: Card with min-h-[120px], max-h-[300px], overflow-y-auto on items section
- **Test Coverage**:
  - Given KitchenOrderCard rendered
  - When inspecting classes
  - Then min-h-[120px] and max-h-[300px] classes present
- **Status**: âœ“ VALIDATED

**AC 8: Visual indicator for orders with special instructions (icon or badge)**
- **Implementation**: ğŸ—’ï¸ icon in card header when hasSpecialInstructions is true, plus "Special instructions" badge in OrderItemsList
- **Test Coverage**:
  - Given order with special instructions
  - When KitchenOrderCard renders
  - Then ğŸ—’ï¸ icon visible in header with title attribute
  - And "Special instructions" badge shown in OrderItemsList
- **Status**: âœ“ VALIDATED

### Security Review

**Status**: âœ“ NO SECURITY CONCERNS

- **Data Exposure**: Card displays only necessary order information (no sensitive data)
- **XSS Protection**: React's built-in XSS protection via JSX, special instructions properly escaped
- **Input Validation**: No user input in this story (read-only display)
- **Access Control**: Kitchen display read-only; security handled at API/route level (future stories)

**Recommendation**: Consistent with Story 3.4 - authentication should restrict kitchen display access in future epic.

### Performance Considerations

**Status**: âœ“ OPTIMIZED

**Strengths**:
- **Efficient Time Updates**: 60-second interval (not excessive), lazy state initialization in useElapsedTime
- **Minimal Re-renders**: useElapsedTime only triggers re-render when elapsed time actually changes
- **Proper Cleanup**: setInterval cleanup prevents memory leaks
- **Optimized Conditionals**: hasSpecialInstructions computed once per render
- **Scrolling Strategy**: overflow-y-auto on items section prevents card expansion

**Performance Measurements**:
- Time formatting: O(1) constant time operations
- Hook updates: 60-second intervals minimal impact
- Component render: Efficient with no unnecessary computations

**Verdict**: Performance is excellent for expected kitchen workloads. No optimizations needed.

### Technical Debt Assessment

**Status**: âœ“ ZERO TECHNICAL DEBT INTRODUCED

The implementation is clean, maintainable, and follows all best practices. No shortcuts or workarounds detected.

**Minor Enhancement Opportunity** (not debt):
- statusConfig duplicated in KitchenOrderCard and StatusColumn - could extract to shared constants file
- This is a minor DRY concern, not technical debt; current approach is acceptable

### Test Architecture Analysis

**Coverage Quality**: â­â­â­â­â­ EXCELLENT

**Test Distribution**:
- KitchenOrderCard: 18 tests (rendering, interactions, accessibility, status colors)
- OrderItemsList: 8 tests (items display, special instructions, edge cases)
- timeUtils: 10 tests (formatting edge cases, hook behavior, timer cleanup)
- **Total**: 36 tests for Story 3.5

**Test Quality Observations**:
1. **Proper Mocking**: useElapsedTime mocked in component tests to isolate timer logic
2. **Fake Timers**: Correctly used vi.useFakeTimers() for time-sensitive tests
3. **Edge Cases**: Empty items, missing menuItem, keyboard events, various time formats
4. **Accessibility Testing**: Verified role, aria-label, tabIndex, keyboard handlers
5. **Integration**: StatusColumn tests updated to work with new KitchenOrderCard
6. **Cleanup Testing**: Verified interval cleanup on unmount

**Test Gaps**: None identified. All ACs have comprehensive test validation.

### Non-Functional Requirements (NFR) Validation

**Security**: âœ“ PASS (no concerns for read-only display)
**Performance**: âœ“ PASS (efficient timer updates, minimal re-renders)
**Reliability**: âœ“ PASS (error handling for missing data, cleanup functions)
**Maintainability**: âœ“ PASS (clear structure, good separation of concerns, comprehensive tests)
**Usability**: âœ“ PASS (clear visual hierarchy, special instructions emphasis, time updates)
**Accessibility**: âœ“ PASS (role, aria-label, keyboard navigation, proper focus management)

### Recommendations

**Immediate Actions**: âœ“ NONE REQUIRED - Implementation is production-ready

**Future Enhancements** (non-blocking):

1. **Code Organization** (Minor):
   - Consider extracting statusConfig to shared constants file (used in both KitchenOrderCard and StatusColumn)
   - Benefits: DRY principle, single source of truth for status colors
   - Impact: Very low priority, current duplication is minimal

2. **Enhanced Time Display** (Nice-to-have):
   - Consider adding visual urgency indicators based on elapsed time (e.g., color changes)
   - This aligns with Story 3.9 (Long Wait Time Alerts) - defer to that story
   - Current implementation is correct as-is

3. **Accessibility Enhancements** (Future consideration):
   - Add aria-live="polite" to time elapsed for screen reader updates
   - Consider announcing special instructions count to screen readers
   - These are nice-to-haves, not blockers

4. **Testing Enhancements** (Optional):
   - Add visual regression tests for card layouts
   - E2E test for live time updates in actual browser environment
   - Current unit tests are sufficient for MVP

### Files Modified During Review

**None** - No refactoring or modifications were necessary. The implementation is excellent as delivered.

### Gate Status

**Gate**: PASS â†’ [docs/qa/gates/3.5-kitchen-order-cards.yml](../qa/gates/3.5-kitchen-order-cards.yml)

**Quality Score**: 98/100

**Breakdown**:
- Code Quality: Excellent (no issues)
- Test Coverage: Comprehensive (36 tests, all ACs covered)
- Requirements Compliance: Full (8/8 ACs met)
- NFR Validation: Strong (all criteria met)
- Technical Debt: Zero
- Code Organization: Minor statusConfig duplication (-2 points)

### Recommended Status

âœ“ **Ready for Done**

Story 3.5 exceeds quality standards and is approved for production deployment. All acceptance criteria met, comprehensive test coverage, zero technical debt, and excellent code quality. The minor statusConfig duplication is a trivial enhancement opportunity, not a blocker.

**Confidence Level**: Very High
**Risk Level**: Low
**Deployment Readiness**: Production-ready

### Integration Notes

**Seamless Integration with Story 3.4**:
- Successfully replaced placeholder cards in StatusColumn
- Maintains all existing StatusColumn functionality
- All 11 StatusColumn tests still passing after integration
- Kitchen display now shows rich order details as designed

**Foundation for Future Stories**:
- Story 3.6 (Drag-and-Drop): onClick handler already present for future interaction
- Story 3.8 (Notifications): Visual structure supports adding notification indicators
- Story 3.9 (Wait Time Alerts): Time elapsed display ready for color-coded urgency

