# Story 1.4: Menu Item Image Upload

## Status: Done

## Story

**As an** Admin user,  
**I want** to upload images for menu items,  
**so that** items display with visual representation.

## Acceptance Criteria

1. `POST /api/upload` endpoint accepts image file (multipart/form-data)
2. Supported formats: JPEG, PNG, WebP (reject others with 400 error)
3. Maximum file size: 5MB (reject larger with 413 error)
4. Image saved to local `uploads/` directory with unique filename (UUID)
5. Endpoint returns the image URL path for storage in menu item record
6. `GET /uploads/:filename` serves uploaded images statically
7. Uploads directory excluded from git via .gitignore

## Tasks / Subtasks

- [x] **Task 1: Install Multer and UUID Dependencies** (AC: 1, 4)
  - [x] Add `multer` and `@types/multer` to api package
  - [x] Add `uuid` and `@types/uuid` to api package for unique filename generation
  - [x] Verify package installation with `pnpm install`

- [x] **Task 2: Create Upload Middleware** (AC: 1, 2, 3, 4)
  - [x] Create `packages/api/src/middleware/upload.ts`
  - [x] Configure multer disk storage with destination `uploads/`
  - [x] Implement filename function using UUID + original extension
  - [x] Define ALLOWED_TYPES: `['image/jpeg', 'image/png', 'image/webp']`
  - [x] Define MAX_SIZE: `5 * 1024 * 1024` (5MB)
  - [x] Implement fileFilter to reject invalid MIME types with AppError (400)
  - [x] Configure multer with storage, limits, and fileFilter
  - [x] Export configured `upload` middleware

- [x] **Task 3: Create Upload Route** (AC: 1, 5)
  - [x] Create `packages/api/src/routes/upload.ts`
  - [x] Implement `POST /` route using `upload.single('image')` middleware
  - [x] Return success response with `{ data: { url: '/uploads/{filename}' } }`
  - [x] Handle case where no file provided (400 error)
  - [x] Ensure route returns 201 status on successful upload

- [x] **Task 4: Configure Static File Serving** (AC: 6)
  - [x] Update `packages/api/src/app.ts` to serve static files from `uploads/`
  - [x] Add `app.use('/uploads', express.static('uploads'))` before API routes
  - [x] Verify static files accessible via `GET /uploads/:filename`

- [x] **Task 5: Mount Upload Route** (AC: 1)
  - [x] Update `packages/api/src/routes/index.ts` to import upload routes
  - [x] Mount upload routes at `/upload` path
  - [x] Verify route accessible at `POST /api/upload`

- [x] **Task 6: Create Uploads Directory and Gitignore** (AC: 4, 7)
  - [x] Create `packages/api/uploads/` directory
  - [x] Create `packages/api/uploads/.gitkeep` to preserve directory in git
  - [x] Add `packages/api/uploads/*` to root `.gitignore` (exclude .gitkeep)
  - [x] Verify uploads directory exists but contents are ignored

- [x] **Task 7: Handle File Size Exceeded Error** (AC: 3)
  - [x] Update error handler middleware to catch MulterError
  - [x] Return 413 status for `LIMIT_FILE_SIZE` error
  - [x] Return appropriate error response format: `{ error: { code: 'FILE_TOO_LARGE', message: '...' } }`

- [x] **Task 8: Write Unit Tests for Upload Middleware** (AC: 2, 3)
  - [x] Create `packages/api/tests/upload.test.ts`
  - [x] Test file type validation (accept JPEG, PNG, WebP)
  - [x] Test file type rejection (reject other types with 400)
  - [x] Test filename generation uses UUID format
  - [x] Verify fileFilter behavior with mocked file objects

- [x] **Task 9: Write Integration Tests for Upload Endpoint** (AC: 1-6)
  - [x] Add upload integration tests to test file
  - [x] Test successful JPEG upload returns 201 with URL
  - [x] Test successful PNG upload returns 201 with URL
  - [x] Test successful WebP upload returns 201 with URL
  - [x] Test invalid file type returns 400 with INVALID_FILE_TYPE error
  - [x] Test file > 5MB returns 413 with FILE_TOO_LARGE error
  - [x] Test missing file returns 400 error
  - [x] Test uploaded file accessible via static route
  - [x] Clean up test files after each test

## Dev Notes

### Previous Story Insights
[Source: Story 1.3 Dev Agent Record]

- Service layer pattern established for business logic separation
- Error handling uses `AppError` class from `packages/api/src/utils/errors.ts`
- Route aggregator pattern in `packages/api/src/routes/index.ts` for mounting routes
- Response helpers `sendSuccess()` and `sendError()` from `packages/api/src/utils/response.ts`
- TypeScript strict mode - use proper type assertions (e.g., `req.params['id']!`)
- Routes mounted under `/api` prefix via route aggregator

### File Upload Configuration
[Source: architecture.md#File Upload Security]

```typescript
// packages/api/src/middleware/upload.ts
import multer from 'multer';
import path from 'path';
import { v4 as uuidv4 } from 'uuid';
import { AppError } from '../utils/errors';

const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
const MAX_SIZE = 5 * 1024 * 1024; // 5MB

const storage = multer.diskStorage({
  destination: 'uploads/',
  filename: (req, file, cb) => {
    const ext = path.extname(file.originalname);
    cb(null, `${uuidv4()}${ext}`);
  },
});

export const upload = multer({
  storage,
  limits: { fileSize: MAX_SIZE },
  fileFilter: (req, file, cb) => {
    if (ALLOWED_TYPES.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new AppError('INVALID_FILE_TYPE', 'Only JPEG, PNG, and WebP images are allowed', 400));
    }
  },
});
```

### Static File Serving
[Source: architecture.md#Express App Setup]

```typescript
// In packages/api/src/app.ts
app.use('/uploads', express.static('uploads'));
```

### API Endpoint Specification
[Source: architecture.md#Endpoints Overview]

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/upload` | Upload image |

**Success Response (201):**
```json
{
  "data": {
    "url": "/uploads/550e8400-e29b-41d4-a716-446655440000.jpg"
  }
}
```

**Error Response - Invalid File Type (400):**
```json
{
  "error": {
    "code": "INVALID_FILE_TYPE",
    "message": "Only JPEG, PNG, and WebP images are allowed"
  }
}
```

**Error Response - File Too Large (413):**
```json
{
  "error": {
    "code": "FILE_TOO_LARGE",
    "message": "File size exceeds maximum allowed (5MB)"
  }
}
```

### Project Structure - New Files
[Source: architecture.md#Project Structure]

| File | Purpose |
|------|---------|
| `packages/api/src/middleware/upload.ts` | Multer configuration and file validation |
| `packages/api/src/routes/upload.ts` | Upload endpoint handler |
| `packages/api/uploads/` | Directory for storing uploaded images (gitignored) |
| `packages/api/uploads/.gitkeep` | Placeholder to preserve directory in git |
| `packages/api/tests/upload.test.ts` | Upload functionality tests |

### Tech Stack Versions
[Source: architecture.md#Tech Stack]

| Technology | Version | Purpose |
|------------|---------|---------|
| Multer | 1.4+ | Multipart form handling |
| uuid | 9.0+ | UUID generation for filenames |

### Multer Error Handling
[Source: Multer documentation pattern]

```typescript
import { MulterError } from 'multer';

// In error-handler.ts, add handling for MulterError:
if (error instanceof MulterError) {
  if (error.code === 'LIMIT_FILE_SIZE') {
    return res.status(413).json({
      error: {
        code: 'FILE_TOO_LARGE',
        message: 'File size exceeds maximum allowed (5MB)',
      },
    });
  }
}
```

### Existing Error Utilities
[Source: packages/api/src/utils/errors.ts - Story 1.3]

```typescript
export class AppError extends Error {
  constructor(
    public code: string,
    message: string,
    public statusCode: number = 400
  ) {
    super(message);
    this.name = 'AppError';
  }
}
```

### Response Format
[Source: packages/api/src/utils/response.ts - Story 1.3]

```typescript
export function sendSuccess(res: Response, data: any, status: number = 200) {
  return res.status(status).json({ data });
}
```

---

## Testing

### Testing Standards
[Source: architecture.md#Testing Strategy]

- **Framework:** Vitest 1.0+
- **Test Location:** `packages/api/tests/`
- **Integration Testing:** Use supertest for endpoint testing
- **File Upload Testing:** Create test image buffers for upload tests
- **Cleanup:** Remove uploaded test files after each test

### Test Pattern for File Upload

```typescript
// packages/api/tests/upload.test.ts
import { describe, it, expect, beforeAll, afterAll, afterEach } from 'vitest';
import request from 'supertest';
import fs from 'fs';
import path from 'path';
import { createApp } from '../src/app.js';
import { prisma, connectDatabase, disconnectDatabase } from '../src/lib/prisma.js';

describe('Upload API', () => {
  let app: Express;
  const uploadedFiles: string[] = [];

  beforeAll(async () => {
    await connectDatabase();
    app = createApp(prisma);
  });

  afterAll(async () => {
    await disconnectDatabase();
  });

  afterEach(() => {
    // Clean up uploaded test files
    uploadedFiles.forEach(file => {
      const filePath = path.join('uploads', file);
      if (fs.existsSync(filePath)) {
        fs.unlinkSync(filePath);
      }
    });
    uploadedFiles.length = 0;
  });

  describe('POST /api/upload', () => {
    it('should upload JPEG image successfully', async () => {
      const res = await request(app)
        .post('/api/upload')
        .attach('image', Buffer.from('fake-jpeg-data'), {
          filename: 'test.jpg',
          contentType: 'image/jpeg',
        });

      expect(res.status).toBe(201);
      expect(res.body.data.url).toMatch(/^\/uploads\/[\w-]+\.jpg$/);
      
      // Track for cleanup
      const filename = res.body.data.url.split('/').pop();
      uploadedFiles.push(filename);
    });

    it('should reject non-image file with 400', async () => {
      const res = await request(app)
        .post('/api/upload')
        .attach('image', Buffer.from('fake-pdf-data'), {
          filename: 'test.pdf',
          contentType: 'application/pdf',
        });

      expect(res.status).toBe(400);
      expect(res.body.error.code).toBe('INVALID_FILE_TYPE');
    });
  });
});
```

---

## Dev Agent Record

**Agent Model Used:** Claude Sonnet 4.5

**Debug Log References:**
- No significant issues encountered during implementation
- Multer fileFilter callback typing required `as any` cast for AppError compatibility
- All tests passing on first run after implementation

**Completion Notes:**
- All 9 tasks completed with full implementation
- Multer 2.0+ and uuid 9.0+ successfully installed
- Upload middleware created with proper file type and size validation
- MulterError handling added to error handler middleware (413 for file too large)
- Static file serving configured at `/uploads` route
- Upload endpoint created at `POST /api/upload` returning 201 with URL
- Uploads directory created with .gitkeep, properly gitignored
- 10 comprehensive integration tests written covering all acceptance criteria
- All 45 tests passing (10 new upload tests + 35 existing)
- TypeScript compilation clean across all packages

**File List:**
- Created `packages/api/src/middleware/upload.ts` - Multer configuration with file validation
- Created `packages/api/src/routes/upload.ts` - Upload endpoint handler
- Created `packages/api/uploads/.gitkeep` - Placeholder to preserve directory in git
- Created `packages/api/tests/upload.test.ts` - Integration tests for upload functionality (10 tests)
- Modified `packages/api/src/app.ts` - Added static file serving for `/uploads`
- Modified `packages/api/src/routes/index.ts` - Mounted upload routes at `/upload`
- Modified `packages/api/src/middleware/error-handler.ts` - Added MulterError handling for file size errors
- Modified `.gitignore` - Updated to exclude uploads/* but keep .gitkeep
- Added dependencies: multer, uuid, @types/multer

**Change Log:**
- Implemented multipart/form-data file upload with Multer
- File validation: JPEG, PNG, WebP only (400 for invalid types)
- Size validation: 5MB max (413 for exceeding limit)
- UUID-based filename generation for uniqueness
- Static file serving for uploaded images
- Comprehensive test coverage for all upload scenarios

---

## QA Results

**Reviewed By:** Quinn (Test Architect)  
**Review Date:** 2025-01-21  
**Gate Decision:** ✅ **PASS**  
**Quality Score:** 98/100

### Requirements Traceability

All 7 acceptance criteria fully verified with comprehensive test evidence:

| AC | Requirement | Status | Evidence |
|----|-------------|--------|----------|
| AC1 | POST /api/upload accepts multipart/form-data | ✅ VERIFIED | Integration tests L33-48, route implementation |
| AC2 | Formats: JPEG/PNG/WebP, reject others (400) | ✅ VERIFIED | 5 tests (3 success + 2 rejection), ALLOWED_TYPES config |
| AC3 | Max 5MB, reject larger (413) | ✅ VERIFIED | Test L113-128, MAX_SIZE config, MulterError handling |
| AC4 | UUID filenames in uploads/ directory | ✅ VERIFIED | UUID format test L130-150, disk verification L152-168 |
| AC5 | Returns URL path (/uploads/{uuid}.ext) | ✅ VERIFIED | All success tests verify response format |
| AC6 | Static serving GET /uploads/:filename | ✅ VERIFIED | Static serving test L172-190, app.ts config |
| AC7 | Uploads excluded from git | ✅ VERIFIED | .gitignore config, .gitkeep preserves directory |

**Requirements Pattern Validation:**
- **AC1:** Given multipart request → When POST /api/upload → Then 201 with URL
- **AC2:** Given invalid MIME type → When upload → Then 400 INVALID_FILE_TYPE  
- **AC3:** Given 6MB file → When upload → Then 413 FILE_TOO_LARGE
- **AC4:** Given any upload → When filename generated → Then UUID format preserved
- **AC5:** Given successful upload → When response returned → Then URL matches /uploads/{uuid}.{ext}
- **AC6:** Given uploaded file → When GET /uploads/:filename → Then 200 with content
- **AC7:** Given uploads/ directory → When git status → Then contents ignored, .gitkeep tracked

### Code Quality Assessment

**Architecture (10/10):** Perfect adherence to Story 1.3 patterns—middleware separation, AppError usage, route aggregator integration, response helpers.

**Error Handling (10/10):** Three distinct error cases properly handled with correct HTTP status codes (400 invalid type, 400 missing file, 413 too large). MulterError handling integrated into global error middleware.

**Security (9/10):** File type whitelist, size limits, UUID filenames prevent common vulnerabilities. Minor recommendation: validate file content magic bytes (future enhancement).

**Test Architecture (10/10):** 10 comprehensive integration tests covering all ACs, proper cleanup (afterEach), boundary testing (6MB file), disk verification, end-to-end static serving validation.

**TypeScript (10/10):** Clean compilation, proper types, pragmatic fileFilter typing solution.

### NFR Validation

- **Performance:** ✅ Tests execute 1.59s (45 total), acceptable for upload operations
- **Reliability:** ✅ Error recovery, test cleanup, UUID collision prevention
- **Maintainability:** ✅ Clear separation of concerns, adjustable constants, well-documented tests
- **Security:** ✅ Type validation, size limits, safe filenames, no execution risk

### Risk Profile

All identified risks LOW or MINIMAL severity:

- **MIME Type Spoofing (LOW):** Accepted for MVP—files not executed, future enhancement for magic byte validation
- **Local Storage Scalability (LOW):** Acceptable for MVP, cloud migration planned per architecture.md
- **Disk Growth (MINIMAL):** Out of scope for MVP, future cleanup policy

### Test Results

```
✅ 45/45 tests passing (100% pass rate)
- 10 upload tests (NEW): Format validation, size limits, UUID filenames, static serving
- 35 existing tests: Menu CRUD, database, health checks
Duration: 1.59s
TypeScript: ✅ Clean compilation (all packages)
```

### Recommendations

**Minor (Low Priority):**
- Consider adding JSDoc comments to upload middleware exports for improved IDE autocomplete experience
- Estimated effort: 5 minutes

**Future Enhancements (Post-MVP):**
- Validate file content magic bytes for stronger security
- Implement cloud storage migration (S3/CDN) for production scalability
- Add upload cleanup policy to manage disk usage

### Gate Summary

Story 1.4 demonstrates **excellent quality** across all dimensions. Implementation perfectly follows established patterns, comprehensive test coverage validates all acceptance criteria, and security measures provide solid MVP foundation. All risks documented with appropriate mitigations.

**Recommendation:** ✅ **APPROVED** for merge and deployment. Ready to mark as Done.

**Gate File:** [docs/qa/gates/1.4-menu-item-image-upload.yml](../qa/gates/1.4-menu-item-image-upload.yml)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 0.3 | QA review completed - PASS gate | Quinn (QA) |
| 2026-01-13 | 0.2 | Development completed - all tasks done | James (Dev) |
| 2026-01-13 | 0.1 | Initial story draft | Bob (SM) |

